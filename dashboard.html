<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CT&P Portal</title>
  <meta name="description" content="CT&P Portal for inspection job tracking and coordination." />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0c121a;
      --text:#e7eef8;
      --muted:#9fb0c6;
      --line:rgba(255,255,255,.08);
      --accent:#3aa0ff;
      --good:#23c26b;
      --warn:#ffb020;
      --bad:#ff4d4d;
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --radius:16px;
      --bg-grad-1: rgba(58,160,255,.18);
      --bg-grad-2: rgba(35,194,107,.12);
      --topbar-bg: rgba(11,15,20,.72);
      --surface-soft: rgba(255,255,255,.03);
      --surface-mid: rgba(0,0,0,.22);
      --surface-strong: rgba(0,0,0,.35);
      --surface-hover: rgba(255,255,255,.06);
      --surface-elev: rgba(0,0,0,.18);
      --table-head-bg: rgba(255,255,255,.02);
      --table-row-border: rgba(255,255,255,.06);
      --overlay: rgba(0,0,0,.55);
      --drawer-start: rgba(15,22,32,.98);
      --drawer-end: rgba(12,18,26,.98);
      --popup-bg: rgba(15,22,32,.98);
      --popup-border: rgba(255,255,255,.08);
      --accent-soft: rgba(58,160,255,.12);
      --accent-soft-hover: rgba(58,160,255,.18);
      --chart-bg: rgba(255,255,255,.02);
      --chart-axis: rgba(255,255,255,.08);
      --chart-grid: rgba(255,255,255,.06);
      --chart-tick: rgba(231,238,248,.65);
      --chart-value: rgba(231,238,248,.82);
      --chart-label: rgba(159,176,198,.85);
      --chart-bar-stroke: rgba(255,255,255,.10);
    }

    body.theme-light{
      --bg:#e9eef5;
      --panel:#f9fcff;
      --panel2:#f2f7fd;
      --text:#0f1a2b;
      --muted:#4e5f79;
      --line:rgba(15,23,42,.14);
      --accent:#0d8ef2;
      --good:#18a455;
      --warn:#d18a05;
      --bad:#d93d3d;
      --shadow:0 20px 60px rgba(8,26,56,.18);
      --bg-grad-1: rgba(13,142,242,.18);
      --bg-grad-2: rgba(16,185,129,.12);
      --topbar-bg: rgba(233,238,245,.8);
      --surface-soft: rgba(255,255,255,.7);
      --surface-mid: rgba(255,255,255,.85);
      --surface-strong: rgba(15,23,42,.18);
      --surface-hover: rgba(15,23,42,.08);
      --surface-elev: rgba(255,255,255,.72);
      --table-head-bg: rgba(255,255,255,.88);
      --table-row-border: rgba(15,23,42,.12);
      --overlay: rgba(8,26,56,.28);
      --drawer-start: rgba(249,252,255,.98);
      --drawer-end: rgba(242,247,253,.98);
      --popup-bg: rgba(249,252,255,.98);
      --popup-border: rgba(15,23,42,.14);
      --accent-soft: rgba(13,142,242,.14);
      --accent-soft-hover: rgba(13,142,242,.22);
      --chart-bg: rgba(255,255,255,.9);
      --chart-axis: rgba(15,23,42,.25);
      --chart-grid: rgba(15,23,42,.12);
      --chart-tick: rgba(15,23,42,.72);
      --chart-value: rgba(15,23,42,.9);
      --chart-label: rgba(37,52,77,.8);
      --chart-bar-stroke: rgba(15,23,42,.2);
    }

    body.theme-light .tabs{ background: var(--surface-elev); }
    body.theme-light .tab:hover{ background: var(--surface-hover); }
    body.theme-light .input,
    body.theme-light .select{ background: var(--surface-mid); }


    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 500px at 15% -10%, var(--bg-grad-1), transparent 55%),
        radial-gradient(900px 500px at 95% 10%, var(--bg-grad-2), transparent 50%),
        var(--bg);
      color:var(--text);
    }

    a{ color:inherit; text-decoration:none; }
    button, input, select{ font:inherit; color:inherit; }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:20px 16px 80px;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter: blur(10px);
      background: var(--topbar-bg);
      border-bottom:1px solid var(--line);
    }

    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }

    .top-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
      flex:1;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .brand img{
      height:42px;
      width:auto;
      display:block;
      filter: drop-shadow(0 8px 20px rgba(0,0,0,.35));
    }

    .brand-title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .brand-title h1{
      margin:0;
      font-size:16px;
      letter-spacing:.4px;
      font-weight:800;
      text-transform: uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .brand-title p{
      margin:0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .menu-hamburger{
      width:46px;
      height:46px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--surface-soft);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .18s ease, background .15s ease, border-color .15s ease;
      flex-shrink:0;
    }
    .menu-hamburger:hover{
      background:var(--accent-soft);
      border-color:rgba(58,160,255,.4);
      transform:translateY(-1px);
    }
    .menu-hamburger.is-open{
      background:var(--accent-soft);
      border-color:rgba(58,160,255,.4);
    }

    .burger{
      width:22px;
      height:18px;
      position:relative;
    }
    .burger span{
      position:absolute;
      left:0;
      right:0;
      height:3px;
      background:currentColor;
      border-radius:999px;
      transition: transform .18s ease, top .18s ease, opacity .18s ease;
    }
    .burger span:nth-child(1){ top:0; }
    .burger span:nth-child(2){ top:7.5px; }
    .burger span:nth-child(3){ top:15px; }
    .menu-hamburger.is-open .burger span:nth-child(1){
      top:7.5px;
      transform:rotate(45deg);
    }
    .menu-hamburger.is-open .burger span:nth-child(2){ opacity:0; }
    .menu-hamburger.is-open .burger span:nth-child(3){
      top:7.5px;
      transform:rotate(-45deg);
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .menu-backdrop{
      position:fixed;
      inset:0;
      background:var(--overlay);
      z-index:58;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease;
    }
    .menu-backdrop.open{
      opacity:1;
      pointer-events:auto;
    }

    .menu-drawer{
      position:fixed;
      top:0;
      left:0;
      height:100%;
      width:360px;
      max-width:85vw;
      background: linear-gradient(180deg, var(--drawer-start), var(--drawer-end));
      border-right:1px solid var(--line);
      box-shadow: var(--shadow);
      z-index:59;
      transform:translateX(-102%);
      transition: transform .25s cubic-bezier(.2,.8,.2,1);
      display:flex;
      flex-direction:column;
    }
    .menu-drawer.open{ transform:translateX(0); }

    .menu-head{
      padding:20px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .menu-title{
      font-weight:900;
      font-size:15px;
      letter-spacing:.2px;
    }
    .menu-close{
      background:none;
      border:0;
      color:var(--muted);
      font-size:24px;
      cursor:pointer;
      line-height:1;
      padding:6px 8px;
      border-radius:10px;
    }
    .menu-close:hover{
      background:var(--surface-hover);
      color:var(--text);
    }

    .menu-body{
      padding:20px;
      font-size:13px;
      color:var(--muted);
      line-height:1.65;
      overflow:auto;
    }
    .menu-section{ margin-bottom:18px; }
    .menu-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1px;
      font-weight:900;
      opacity:.65;
      margin: 0 0 10px;
    }
    .menu-link{
      display:block;
      padding:14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--surface-soft);
      color:var(--text);
      font-weight:800;
      text-decoration:none;
      margin-bottom:10px;
      transition:.15s;
    }
    .menu-link:hover{
      background:var(--accent-soft);
      border-color:rgba(58,160,255,.4);
    }
    .menu-notice{
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--surface-soft);
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }
    .menu-notice strong{
      color:var(--text);
      font-weight:900;
    }
    .menu-meta-box{
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--surface-mid);
      color:var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      line-height:1.6;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }

    .pill strong{ color:var(--text); font-weight:800; }

    .theme-switch{
      border:0;
      padding:0;
      background:transparent;
      cursor:pointer;
      line-height:0;
    }

    .theme-track{
      position:relative;
      width:86px;
      height:40px;
      border-radius:999px;
      display:block;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(165deg, #7d848e 0%, #4c525d 100%);
      box-shadow:
        inset 0 2px 2px rgba(255,255,255,.14),
        inset 0 -6px 12px rgba(0,0,0,.35),
        0 7px 14px rgba(0,0,0,.25);
      transition: background .28s ease, border-color .28s ease, box-shadow .28s ease;
    }

    .theme-track::before{
      content:"";
      position:absolute;
      inset:3px;
      border-radius:999px;
      background: linear-gradient(180deg, #757d88 0%, #5a616d 100%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.16), inset 0 -3px 6px rgba(0,0,0,.24);
      z-index:1;
    }

    .theme-thumb{
      position:absolute;
      top:4px;
      left:4px;
      width:37px;
      height:32px;
      border-radius:999px;
      z-index:2;
      background: linear-gradient(180deg, #8b929d 0%, #5c6470 100%);
      box-shadow:
        inset 0 1px 1px rgba(255,255,255,.25),
        inset 0 -2px 5px rgba(0,0,0,.28),
        0 4px 8px rgba(0,0,0,.3);
      transition: left .28s ease, background .28s ease, box-shadow .28s ease;
    }

    .theme-icon{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:16px;
      height:16px;
      color:rgba(255,255,255,.5);
      z-index:3;
      transition: color .28s ease, filter .28s ease, opacity .28s ease;
      pointer-events:none;
    }
    .theme-icon svg{
      width:100%;
      height:100%;
      display:block;
      fill:currentColor;
    }
    .theme-icon-sun{ left:12px; }
    .theme-icon-moon{ right:12px; }

    body.theme-light .theme-thumb{
      left:4px;
      background: linear-gradient(180deg, #9097a1 0%, #656d79 100%);
      box-shadow:
        inset 0 1px 1px rgba(255,255,255,.24),
        inset 0 -2px 5px rgba(0,0,0,.27),
        0 4px 8px rgba(0,0,0,.3);
    }
    body.theme-light .theme-icon-sun{
      color:#ffffff;
      filter: drop-shadow(0 0 6px rgba(255,255,255,.9)) drop-shadow(0 0 12px rgba(255,255,255,.5));
      opacity:1;
    }
    body.theme-light .theme-icon-moon{
      color:rgba(201,220,255,.55);
      filter:none;
      opacity:.6;
    }

    body.theme-dark .theme-track{
      border-color: rgba(76,140,255,.3);
      background: linear-gradient(165deg, #7a818d 0%, #49505d 100%);
      box-shadow:
        inset 0 2px 2px rgba(255,255,255,.12),
        inset 0 -6px 12px rgba(0,0,0,.36),
        0 7px 14px rgba(0,0,0,.28);
    }
    body.theme-dark .theme-thumb{
      left:45px;
      background: linear-gradient(180deg, #7f8691 0%, #58606c 100%);
      box-shadow:
        inset 0 1px 1px rgba(255,255,255,.22),
        inset 0 -2px 6px rgba(0,0,0,.3),
        0 4px 8px rgba(0,0,0,.32);
    }
    body.theme-dark .theme-icon-sun{
      color:rgba(255,255,255,.45);
      filter:none;
      opacity:.55;
    }
    body.theme-dark .theme-icon-moon{
      color:#d8e9ff;
      filter: drop-shadow(0 0 6px rgba(92,164,255,.95)) drop-shadow(0 0 14px rgba(92,164,255,.7));
      opacity:1;
    }

    .theme-switch:focus-visible .theme-track{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }


    /* Tabs */
    .tabs{
      display:inline-flex;
      gap:6px;
      padding:6px;
      border:1px solid var(--line);
      border-radius:999px;
      background: var(--surface-elev);
    }
    .tab{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid transparent;
      background: transparent;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      font-size:12px;
      color: var(--muted);
      transition: background .12s ease, border-color .12s ease, transform .08s ease;
      white-space:nowrap;
    }
    .tab:hover{ background: var(--surface-hover); }
    .tab:active{ transform: translateY(1px); }
    .tab.active{
      color: var(--text);
      background: var(--accent-soft);
      border-color: rgba(58,160,255,.25);
    }

    .grid{ display:grid; gap:12px; }

    .stats{
      grid-template-columns: repeat(4, minmax(0, 1fr));
      margin-top:18px;
    }

    .card{
      background: rgba(255,255,255,.035);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 8px 30px rgba(0,0,0,.18);
    }

    .stat{
      padding:14px 14px 12px;
      position:relative;
      overflow:hidden;
    }

    .stat .label{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.3px;
    }

    .stat .value{
      margin-top:6px;
      font-size:26px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .stat .hint{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
    }

    .stat::after{
      content:"";
      position:absolute;
      inset:auto -40px -60px auto;
      width:140px;
      height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(58,160,255,.25), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    .panel{
      margin-top:14px;
      padding:14px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: var(--radius);
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
    }

    .controls-left{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      min-width:0;
    }

    .input{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: var(--surface-mid);
      min-width: 280px;
    }

    .input input{
      border:0;
      outline:none;
      background:transparent;
      width:100%;
      color:var(--text);
    }

    .select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: var(--surface-mid);
      color:var(--text);
      outline:none;
    }

    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: var(--surface-soft);
      cursor:pointer;
      transition: transform .08s ease, background .12s ease;
      font-weight:700;
      letter-spacing:.2px;
    }

    .btn:hover{ background: var(--surface-hover); }
    .btn:active{ transform: translateY(1px); }

    .meta{
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      text-align:right;
    }

    .ticker{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: var(--surface-mid);
      overflow:hidden;
    }

    .ticker-label{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.6px;
      white-space:nowrap;
      font-weight:700;
    }

    .ticker-track{
      position:relative;
      flex:1;
      overflow:hidden;
      min-height:18px;
    }

    .ticker-text{
      display:inline-block;
      white-space:nowrap;
      padding-left:100%;
      animation: ticker-move 22s linear infinite;
      font-weight:600;
      color:var(--text);
    }

    .ticker-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(58,160,255,.25);
      background:var(--accent-soft);
      color:var(--text);
      font-weight:900;
      letter-spacing:.15px;
      line-height:1.2;
      white-space:nowrap;
    }
    .ticker-sep{
      color:var(--muted);
      margin:0 8px;
      opacity:.9;
    }

    .ticker.is-new .ticker-text{
      animation-duration: 18s;
      color:#bfe4ff;
    }
    .ticker.is-new .ticker-pill{
      border-color: rgba(58,160,255,.45);
      background: rgba(58,160,255,.2);
      color:#bfe4ff;
    }

    .ticker:hover .ticker-text{
      animation-play-state: paused;
    }

    @keyframes ticker-move{
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    @media (prefers-reduced-motion: reduce){
      .ticker-text{
        animation: none;
        padding-left:0;
      }
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--surface-mid);
      font-weight:900;
      letter-spacing:.2px;
    }

    .badge .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
    }
    .b-live .dot{ background: var(--good); }
    .b-error .dot{ background: var(--bad); }
    .b-loading .dot{ background: var(--warn); }
    .b-new .dot{ background: var(--warn); }

    .table-wrap{
      margin-top:12px;
      overflow:auto;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: var(--surface-elev);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 980px;
    }

    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.35px;
      text-transform: uppercase;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: var(--table-head-bg);
      position:sticky;
      top:0;
      z-index:1;
    }

    tbody td{
      padding:12px 12px;
      border-bottom:1px solid var(--table-row-border);
      font-size:13px;
      vertical-align:top;
    }

    tbody tr:hover{ background: var(--surface-soft); }

    .jobid{
      font-weight:900;
      letter-spacing:.4px;
      white-space:nowrap;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }

    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
    }
    .s-assigned .dot{ background: #f59e0b; }
    .s-pending .dot{ background: var(--warn); }
    .s-progress .dot{ background: var(--accent); }
    .s-done .dot{ background: var(--good); }
    .s-cancel .dot{ background: var(--bad); }

    .assignees{
      display:flex;
      flex-direction:column;
      gap:6px;
      color:var(--text);
    }
    .assignees span{ color: var(--muted); font-weight:700; }
    .assignees b{ color: var(--text); font-weight:800; }

    .view-btn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background: var(--accent-soft);
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .view-btn:hover{ background: var(--accent-soft-hover); }

    .backdrop{
      position:fixed;
      inset:0;
      background: var(--overlay);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:40;
    }

    .drawer{
      position:fixed;
      top:0;
      right:0;
      height:100%;
      width:min(520px, 92vw);
      background: linear-gradient(180deg, var(--drawer-start), var(--drawer-end));
      border-left:1px solid var(--line);
      box-shadow: var(--shadow);
      transform: translateX(104%);
      transition: transform .22s ease;
      z-index:50;
      display:flex;
      flex-direction:column;
    }

    .drawer.open{ transform: translateX(0); }
    .backdrop.open{ opacity:1; pointer-events:auto; }

    .drawer-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .drawer-title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .drawer-title .kicker{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.3px;
      text-transform:uppercase;
      font-weight:900;
    }
    .drawer-title h2{
      margin:0;
      font-size:18px;
      font-weight:1000;
      letter-spacing:.3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .drawer-title p{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .icon-btn{
      width:40px;
      height:40px;
      border-radius:12px;
      border:1px solid var(--line);
      background: var(--surface-soft);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight:1000;
    }
    .icon-btn:hover{ background: var(--surface-hover); }

    .drawer-body{
      padding:14px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .section{
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: var(--surface-elev);
    }

    .section h3{
      margin:0 0 10px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.35px;
      text-transform:uppercase;
      font-weight:1000;
    }

    .kv{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap:8px 12px;
      font-size:13px;
    }
    .kv .k{
      color:var(--muted);
      font-weight:800;
    }
    .kv .v{
      color:var(--text);
      font-weight:750;
      word-break:break-word;
    }

    .doc-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .doc{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: var(--surface-soft);
    }

    .doc .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .doc .name{
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .doc .note{
      color:var(--muted);
      font-size:12px;
    }

    .doc a{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background: var(--surface-soft);
      font-weight:900;
      white-space:nowrap;
    }
    .doc a:hover{ background: var(--surface-hover); }

    /* ===== Directory + Analytics styles ===== */
    .view{ display:none; }
    .view.active{ display:block; }

    .panel-title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .panel-title h2{
      margin:0;
      font-size:14px;
      font-weight:1000;
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .panel-title p{
      margin:4px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .split{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top:14px;
      align-items:start;
    }

    .dir-grid{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .person{
      display:flex;
      gap:12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface-elev);
      overflow:hidden;
    }

    .person .photo-wrap{
      width:140px;
      min-width:140px;
      border-right:1px solid var(--line);
      background:
        radial-gradient(220px 120px at 30% 20%, rgba(58,160,255,.18), transparent 60%),
        radial-gradient(220px 120px at 70% 80%, rgba(35,194,107,.10), transparent 60%),
        rgba(255,255,255,.02);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
    }

    .person img{
      width:110px;
      height:130px;
      object-fit:cover;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }

    .person .body{
      flex:1;
      padding:12px 12px 12px 0;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }

    .person .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding-right:12px;
    }

    .person h3{
      margin:0;
      font-size:14px;
      font-weight:1000;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .tag b{ color:var(--text); font-weight:1000; }

    .person .tags{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding-right:12px;
    }

    .load-bar{
      margin-top:8px;
      height:8px;
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      padding-right:12px;
    }
    .load-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      transition: width .2s ease;
    }
    .load-label{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
      padding-right:12px;
    }

    .person p{
      margin:0;
      color: var(--text);
      font-size:13px;
      line-height:1.45;
      padding-right:12px;
    }

    .chart-card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface-elev);
      padding:12px;
      margin-top:12px;
    }

    .chart-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .chart-head h3{
      margin:0;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.35px;
      text-transform:uppercase;
      font-weight:1000;
    }

    .chart-head span{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
    }

    canvas{
      width:100%;
      height:190px;
      display:block;
    }

    .legend{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .leg{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }

    .swatch{
      width:10px;
      height:10px;
      border-radius:3px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.22);
    }

    .mini-note{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    @media (max-width: 980px){
      .stats{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .input{ min-width: 220px; }
      .split{ grid-template-columns: 1fr; }
    }

    @media (max-width: 520px){
      .topbar-inner{
        flex-direction:column;
        align-items:stretch;
        gap:10px;
        padding:12px 12px;
      }
      .top-left{
        width:100%;
      }
      .brand img{
        height:34px;
      }
      .brand-title h1{
        font-size:13px;
      }
      .brand-title p{
        font-size:11px;
      }
      .stats{ grid-template-columns: 1fr; }
      .input{ min-width: 100%; }
      .controls{ gap:12px; }
      .controls-left{ width:100%; }
      .menu-drawer{ width: min(360px, 92vw); }
      .top-actions{
        display:grid;
        width:100%;
        grid-template-columns: auto auto;
        grid-template-areas:
          "theme date"
          "tabs tabs";
        align-items:center;
        gap:8px;
      }
      .top-actions .theme-switch{
        grid-area:theme;
        justify-self:start;
      }
      .tabs{
        grid-area:tabs;
        display:grid;
        grid-template-columns:repeat(3, minmax(0, 1fr));
        width:100%;
        gap:6px;
        border-radius:14px;
      }
      .tab{
        width:100%;
        min-width:0;
        text-align:center;
        padding:8px 10px;
        font-size:11px;
      }
      .pill{
        grid-area:date;
        justify-self:end;
      }
    }

    /* ===== Added: Map + Schedule only (does not change existing UI) ===== */
    .map-wrap{
      margin-top:12px;
      overflow:hidden;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: var(--surface-elev);
    }
    .map-completed{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface-elev);
      padding:10px;
    }
    .map-completed h3{
      margin:0 0 8px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.35px;
      color:var(--muted);
      font-weight:1000;
    }
    .map-state{
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--surface-soft);
      margin-top:8px;
      overflow:hidden;
    }
    .map-state summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      font-weight:900;
      color:var(--text);
    }
    .map-state summary::-webkit-details-marker{ display:none; }
    .map-state summary::after{
      content:"+";
      color:var(--muted);
      font-size:14px;
      line-height:1;
    }
    .map-state[open] summary::after{ content:"-"; }
    .map-state-meta{
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
    }
    .map-ins-list{
      margin:0;
      padding:0 12px 10px;
      list-style:none;
      display:grid;
      gap:8px;
    }
    .map-ins-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 10px;
      background:var(--surface-mid);
      font-size:12px;
    }
    .map-ins-link{
      border:0;
      background:none;
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      font-weight:800;
      text-align:left;
      padding:0;
    }
    .map-ins-link:hover{ color:var(--accent); }
    .map-ins-count{
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
      font-size:11px;
    }
    #map{
      width:100%;
      height:540px;
    }
    .sch-wrap{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.25fr .95fr;
      gap:12px;
    }
    .sch-calendar{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface-elev);
      padding:10px;
    }
    .sch-weekdays{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:6px;
      margin-bottom:6px;
    }
    .sch-weekdays div{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.45px;
      padding:4px 2px;
    }
    .sch-days{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:6px;
    }
    .sch-day{
      min-height:82px;
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--surface-mid);
      padding:8px;
      text-align:left;
      color:var(--text);
      cursor:pointer;
      transition: border-color .12s ease, transform .08s ease, background .12s ease;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .sch-day:hover{
      border-color:rgba(58,160,255,.35);
      background:var(--surface-hover);
    }
    .sch-day:active{ transform:translateY(1px); }
    .sch-day.out{
      opacity:.35;
      cursor:default;
      pointer-events:none;
    }
    .sch-day.today{
      box-shadow: inset 0 0 0 1px rgba(58,160,255,.45);
    }
    .sch-day.selected{
      border-color:rgba(58,160,255,.55);
      box-shadow: 0 0 0 1px rgba(58,160,255,.35) inset, 0 8px 22px rgba(58,160,255,.18);
    }
    .sch-day.has-jobs{
      background: color-mix(in srgb, var(--surface-mid) 80%, var(--accent-soft) 20%);
    }
    .sch-num{
      font-size:12px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .sch-markers{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:4px;
      margin-top:auto;
    }
    .sch-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      display:inline-block;
      box-shadow:0 0 0 2px rgba(255,255,255,.04);
    }
    .sch-dot-assigned{ background:#f59e0b; }
    .sch-dot-progress{ background:#3aa0ff; }
    .sch-dot-completed{ background:#22c55e; }
    .sch-dot-holiday{ background:#ef4444; }
    .sch-dot-salary{ background:#a855f7; }
    .sch-count{
      margin-left:auto;
      font-size:10px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.3px;
    }
    .sch-flags{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:2px;
    }
    .sch-flag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:2px 6px;
      font-size:9px;
      font-weight:900;
      letter-spacing:.3px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .sch-flag-h{
      color:#fecaca;
      background:rgba(239,68,68,.14);
      border-color:rgba(239,68,68,.35);
    }
    .sch-flag-s{
      color:#e9d5ff;
      background:rgba(168,85,247,.16);
      border-color:rgba(168,85,247,.35);
    }
    .sch-side{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface-elev);
      padding:10px;
      min-height: 100%;
    }
    .sch-day-title{
      margin:0;
      font-size:14px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .sch-card-list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:520px;
      overflow:auto;
      padding-right:2px;
    }
    .sch-card{
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--surface-mid);
      padding:10px;
    }
    .sch-card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .sch-card-id{
      font-weight:1000;
      letter-spacing:.25px;
      font-size:12px;
    }
    .sch-card-unit{
      color:var(--text);
      font-size:13px;
      font-weight:800;
      margin-top:4px;
    }
    .sch-card-sub{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      margin-top:4px;
    }
    .sch-special-card{
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--surface-soft);
      padding:10px;
      margin-bottom:8px;
    }
    .sch-special-title{
      margin:0 0 6px;
      font-size:12px;
      font-weight:1000;
      text-transform:uppercase;
      letter-spacing:.35px;
      color:var(--muted);
    }
    .sch-special-row{
      font-size:12px;
      color:var(--text);
      margin-top:4px;
      line-height:1.35;
    }
    .sch-ins-link{
      border:0;
      padding:0;
      margin:0;
      background:none;
      color:var(--accent);
      cursor:pointer;
      font-weight:800;
      text-decoration:underline;
      text-underline-offset:2px;
      font-size:12px;
    }
    .sch-ins-link:hover{ opacity:.85; }
    .sch-mini-legend{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .sch-mini-legend span{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .sch-month-line{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
    }

    @media (max-width: 980px){
      .sch-wrap{
        grid-template-columns:1fr;
      }
      .sch-card-list{
        max-height:none;
      }
    }
    @media (max-width: 520px){
      .sch-day{
        min-height:72px;
        padding:7px;
      }
      .sch-num{
        font-size:11px;
      }
      .sch-weekdays div{
        font-size:10px;
      }
    }

    /* Leaflet popup to match your dark UI */
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip{
      background: var(--popup-bg);
      color: var(--text);
      border:1px solid var(--popup-border);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .leaflet-container a{ color: var(--text); }

   /* =========================================
       MOBILE RESPONSIVENESS FIX
       ========================================= */
    @media (max-width: 768px) and (min-width: 521px) {
      .topbar-inner {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 16px;
      }
      .top-left{
        width:100%;
      }
      .top-actions {
        width: 100%;
        display:grid;
        grid-template-columns: auto 1fr auto;
        align-items:center;
        gap:8px;
        overflow:visible;
        padding-bottom: 0;
      }
      .tabs{
        grid-column:1 / -1;
        display:flex;
        flex-wrap:wrap;
        width:100%;
        gap:6px;
        border-radius:14px;
      }
      .tab{
        flex:1 1 calc(33.333% - 6px);
        min-width:110px;
        text-align:center;
      }
      .pill{
        justify-self:end;
      }
      .stats { grid-template-columns: 1fr 1fr; gap: 8px; }
      .stat .value { font-size: 20px; }
      .wrap { padding: 10px 12px 80px; }
    }

    /* ===== Profile Modal Styles (Added) ===== */
    .link-profile {
      color: var(--accent);
      cursor: pointer;
      font-weight: 700;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .link-profile:hover { opacity:.85; }

    .modal-wrap {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 0;
      width: min(400px, 90vw);
      box-shadow: 0 40px 80px rgba(0,0,0,.6);
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
      overflow: hidden;
    }
    .modal-wrap.open {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    .modal-wrap .person { border: none; background: transparent; border-radius: 0; }
    .modal-close {
      position: absolute;
      top: 10px; right: 10px;
      width: 30px; height: 30px;
      background: var(--surface-strong);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 50%;
      cursor: pointer;
      z-index: 10;
      display: grid;
      place-items: center;
      font-weight: bold;
    }
    .modal-close:hover { background: var(--surface-hover); }

  </style>
</head>

<body class="theme-dark">
  <header class="topbar">
    <div class="topbar-inner">
      <div class="top-left">
        <button class="menu-hamburger" id="menuToggle" aria-label="Buka menu" aria-expanded="false" type="button">
          <div class="burger" aria-hidden="true">
            <span></span><span></span><span></span>
          </div>
        </button>
        <a class="brand" href="index.html">
          <img src="assets/icon1.png" alt="Jata Negara" />
          <div class="brand-title">
            <h1>Sistem Pemantauan Pemeriksaan Sel Teknikal</h1>
            <p>Cawangan Teknik & Pemeriksaan</p>
          </div>
        </a>
      </div>

      <div class="top-actions">
        <button class="theme-switch" id="themeSwitch" type="button" aria-label="Toggle light and dark theme" title="Switch theme">
          <span class="theme-track">
            <span class="theme-thumb"></span>
            <span class="theme-icon theme-icon-sun" aria-hidden="true">
              <svg viewBox="0 0 24 24" role="presentation">
                <path d="M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0-5a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm0 16a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1zm10-6a1 1 0 0 1-1 1h-2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1zM7 12a1 1 0 0 1-1 1H4a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1zm11.07-6.66a1 1 0 0 1 0 1.42l-1.41 1.41a1 1 0 1 1-1.42-1.41l1.42-1.42a1 1 0 0 1 1.41 0zM8.76 15.24a1 1 0 0 1 0 1.41l-1.42 1.42a1 1 0 0 1-1.41-1.42l1.41-1.41a1 1 0 0 1 1.42 0zm0-8.48a1 1 0 0 1-1.42 0L5.93 5.34a1 1 0 0 1 1.41-1.41l1.42 1.41a1 1 0 0 1 0 1.42zm8.49 8.48 1.41 1.41a1 1 0 1 1-1.41 1.42l-1.42-1.42a1 1 0 1 1 1.42-1.41z"></path>
              </svg>
            </span>
            <span class="theme-icon theme-icon-moon" aria-hidden="true">
              <svg viewBox="0 0 24 24" role="presentation">
                <path d="M20.71 14.29A9 9 0 0 1 9.71 3.29a1 1 0 0 0-1.24-1.24A11 11 0 1 0 22 15.53a1 1 0 0 0-1.29-1.24z"></path>
              </svg>
            </span>
          </span>
        </button>

        <div class="tabs" role="tablist" aria-label="Portal Sections">
          <button class="tab active" id="tabJobs" role="tab" aria-selected="true" aria-controls="viewJobs">Jobs</button>
          <button class="tab" id="tabDir" role="tab" aria-selected="false" aria-controls="viewDir">Inspector Directory</button>
          <button class="tab" id="tabAna" role="tab" aria-selected="false" aria-controls="viewAna">Analytics</button>
          <button class="tab" id="tabTime" role="tab" aria-selected="false" aria-controls="viewTime">Schedule</button>
          <button class="tab" id="tabMap" role="tab" aria-selected="false" aria-controls="viewMap">Map</button>
        </div>
        <span class="pill"><strong id="today"></strong></span>
      </div>
    </div>
  </header>

  <div class="menu-backdrop" id="menuBackdrop"></div>

  <aside class="menu-drawer" id="menuDrawer" aria-hidden="true">
    <div class="menu-head">
      <span class="menu-title">Menu & Sumber</span>
      <button class="menu-close" id="menuClose" aria-label="Tutup menu" type="button">&times;</button>
    </div>

    <div class="menu-body">
      <div class="menu-section">
        <div class="menu-label">Borang Dalam Talian</div>

        <a class="menu-link"
           href="https://docs.google.com/forms/d/e/1FAIpQLSdHfQWKturVq4XISrKFqgZG6teJxpDAiVcwuC26hoavMBjGLw/viewform"
           target="_blank" rel="noopener">
          Permohonan Pemeriksaan Alat Ganti Kenderaan ATM
        </a>

        <a class="menu-link"
           href="https://forms.gle/9yxfaEAvEiHfBjTXA"
           target="_blank" rel="noopener">
          Permohonan Mewujudkan Dokumen Peralatan ATM / Penerimaan Peralatan ATM
        </a>

        <a class="menu-link"
           href="https://docs.google.com/forms/d/e/1FAIpQLSc9qcmCLyHy-t-GIo3cz1k9aoTrzk5F-ComMLORNVfxovIJ3A/viewform?usp=sharing&ouid=116666925478114456158"
           target="_blank" rel="noopener">
          Permohonan Pemeriksaan Penerimaan Akhir (FAT)
        </a>
      </div>

      <div class="menu-section">
        <div class="menu-label">Pautan Pantas</div>

        <a class="menu-link" href="about.html">
          Tentang Kami
        </a>

        <a class="menu-link"
           href="https://wa.me/qr/QPQSVVZHMP22L1"
           target="_blank" rel="noopener">
          Hubungi Pentadbir
        </a>

        <a class="menu-link" href="guide.html">
          Garis Panduan
        </a>

        <div class="menu-notice" style="margin-top:10px;">
          <strong>Akses terhad.</strong> Portal ini untuk kegunaan pegawai yang dibenarkan sahaja.
          Aktiviti boleh direkodkan untuk tujuan pematuhan dan audit.
        </div>
      </div>

      <div class="menu-section">
        <div class="menu-label">Maklumat Sistem</div>
        <div class="menu-meta-box">
          Versi: 2.1.0<br/>
          Kemas kini terakhir: 26 Dis 2025<br/>
          Persekitaran: Portal Dalaman
        </div>
      </div>
    </div>
  </aside>

  <main class="wrap">
    <section class="view active" id="viewJobs" role="tabpanel" aria-labelledby="tabJobs">
      <div class="grid stats">
        <div class="card stat">
          <div class="label">Total Jobs</div>
          <div class="value" id="statTotal">0</div>
          <div class="hint">All records loaded</div>
        </div>
        <div class="card stat">
          <div class="label">Pending</div>
          <div class="value" id="statPending">0</div>
          <div class="hint">Need action or assignment</div>
        </div>
        <div class="card stat">
          <div class="label">In Progress</div>
          <div class="value" id="statProgress">0</div>
          <div class="hint">Ongoing inspections</div>
        </div>
        <div class="card stat">
          <div class="label">Completed</div>
          <div class="value" id="statDone">0</div>
          <div class="hint">Closed jobs</div>
        </div>
      </div>

      <section class="panel">
        <div class="controls">
          <div class="controls-left">
            <div class="input" title="Search by Job ID, Unit, Location, Inspector">
              <span style="opacity:.85;">ðŸ”Ž</span>
              <input id="q" type="text" placeholder="Search Job ID, Unit, Lokasi, Pemeriksa" />
            </div>

            <select class="select" id="statusFilter" title="Filter by status">
              <option value="">All Status</option>
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
            </select>

            <select class="select" id="monthFilter" title="Filter by month">
              <option value="">All Months</option>
              <option value="0">January</option>
              <option value="1">February</option>
              <option value="2">March</option>
              <option value="3">April</option>
              <option value="4">May</option>
              <option value="5">June</option>
              <option value="6">July</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">October</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>

            <button class="btn" id="refresh">Refresh</button>
          </div>

          <div class="meta">
            <span>Showing <strong id="count">0</strong> jobs</span>
            <span class="badge b-loading" id="liveBadge"><span class="dot"></span><span id="liveText">Loading</span></span>
            <span class="badge b-new" id="newJobBadge" style="display:none;"><span class="dot"></span><span id="newJobText">New: 0</span></span>
          </div>
        </div>

        <div class="ticker" id="jobsTicker" aria-live="polite">
          <span class="ticker-label">Latest Jobs</span>
          <div class="ticker-track">
            <span class="ticker-text" id="jobsTickerText">Waiting for updates...</span>
          </div>
        </div>

        <div class="table-wrap" style="margin-top:14px;">
          <table>
            <thead>
              <tr>
                <th>Job ID</th>
                <th>Unit / Pasukan</th>
                <th>Jenis Pemeriksaan</th>
                <th>Lokasi</th>
                <th>Tarikh Tugasan</th>
                <th>Status</th>
                <th>Assigned Inspectors</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="grid"></tbody>
          </table>
        </div>
      </section>
    </section>

    <section class="view" id="viewDir" role="tabpanel" aria-labelledby="tabDir">
      <section class="panel">
        <div class="panel-title">
          <div>
            <h2>Inspector Directory</h2>
            <p>Directory data pulled from 'Pemeriksa' sheet. Load metrics calculated from Jobs.</p>
          </div>
          <div class="meta" style="justify-content:flex-end;">
            <a class="btn" href="about.html">Mengenai Kami</a>
            <span class="badge b-live"><span class="dot"></span><span>Active</span></span>
          </div>
        </div>

        <div class="split">
          <div>
            <div class="controls" style="margin-top:12px;">
              <div class="controls-left" style="width:100%;">
                <div class="input" title="Search inspector name">
                  <span style="opacity:.85;">ðŸ”Ž</span>
                  <input id="dirQ" type="text" placeholder="Search inspector name / specialization / zone" />
                </div>
                <select class="select" id="dirSpec" title="Filter by specialization">
                  <option value="">All Specialization</option>
                  <option value="Automotive">Automotive</option>
                  <option value="General">General</option>
                  <option value="Weapon">Weapon</option>
                  <option value="Electronic">Electronic</option>
                </select>
              </div>
              <div class="meta">
                <span>Showing <strong id="dirCount">0</strong> inspectors</span>
              </div>
            </div>

            <div class="dir-grid" id="dirGrid"></div>
            <div class="mini-note" id="dirEmpty" style="display:none;">No inspectors match your filter.</div>
          </div>

          <aside>
            <div class="chart-card">
              <div class="chart-head">
                <h3>Specialization Mix</h3>
                <span id="dirMixNote">0 visible</span>
              </div>
              <canvas id="dirMixChart" width="900" height="280"></canvas>
              <div class="legend" id="dirMixLegend"></div>
            </div>

            <div class="chart-card">
              <div class="chart-head">
                <h3>Inspector Load</h3>
                <span id="dirLoadNote">Based on visible jobs</span>
              </div>
              <canvas id="dirLoadChart" width="900" height="280"></canvas>
              <div class="legend" id="dirLoadLegend"></div>
              <div class="mini-note">Load is count of assignments in the current job list (Inspector 1 + Inspector 2).</div>
            </div>
          </aside>
        </div>
      </section>
    </section>

    <section class="view" id="viewAna" role="tabpanel" aria-labelledby="tabAna">
      <div class="grid stats" style="margin-top:0;">
        <div class="card stat">
          <div class="label">Jobs (Visible)</div>
          <div class="value" id="aTotal">0</div>
          <div class="hint">After search + status filter</div>
        </div>
        <div class="card stat">
          <div class="label">Completion Rate</div>
          <div class="value" id="aRate">0%</div>
          <div class="hint">Completed Ã· visible</div>
        </div>
        <div class="card stat">
          <div class="label">Top Negeri</div>
          <div class="value" id="aTopNegeri">-</div>
          <div class="hint">Most jobs by Negeri</div>
        </div>
        <div class="card stat">
          <div class="label">Top Daerah</div>
          <div class="value" id="aTopDaerah">-</div>
          <div class="hint">Most jobs by Daerah</div>
        </div>
      </div>

      <section class="panel">
        <div class="panel-title">
          <div>
            <h2>Analytics</h2>
            <p>Numbers and charts are computed from the same list you see in Jobs view.</p>
          </div>
          <div class="meta">
            <button class="btn" id="copySummary">Copy summary</button>
          </div>
        </div>

        <div class="split">
          <div>
            <div class="chart-card">
              <div class="chart-head">
                <h3>Status Breakdown</h3>
                <span>Pending, In Progress, Completed, Cancelled</span>
              </div>
              <canvas id="aStatusChart" width="900" height="280"></canvas>
              <div class="legend" id="aStatusLegend"></div>
            </div>

            <div class="chart-card">
              <div class="chart-head">
                <h3>Jobs by Zon</h3>
                <span>Count per Zon</span>
              </div>
              <canvas id="aZoneChart" width="900" height="280"></canvas>
              <div class="legend" id="aZoneLegend"></div>
            </div>
          </div>

          <div class="chart-card">
              <div class="chart-head">
                <h3>TAT Compliance</h3>
                <span>Duration (Application to Inspection)</span>
              </div>
              <canvas id="aTatChart" width="900" height="280"></canvas>
              <div class="legend" id="aTatLegend"></div>
            </div>

          <aside>
            <div class="chart-card">
              <div class="chart-head">
                <h3>Jenis Pemeriksaan</h3>
                <span>Count per type</span>
              </div>
              <canvas id="aJenisChart" width="900" height="280"></canvas>
              <div class="legend" id="aJenisLegend"></div>
            </div>

            <div class="chart-card">
              <div class="chart-head">
                <h3>Inspector Load</h3>
                <span>Top assigned inspectors</span>
              </div>
              <canvas id="aLoadChart" width="900" height="280"></canvas>
              <div class="legend" id="aLoadLegend"></div>
            </div>
          </aside>
        </div>
      </section>
    </section>

    <section class="view" id="viewTime" role="tabpanel" aria-labelledby="tabTime">
      <section class="panel">
        <div class="panel-title">
          <div>
            <h2>Schedule</h2>
            <p>Kalendar tugasan berdasarkan job berstatus Assigned, In Progress, dan Completed.</p>
          </div>
          <div class="meta">
            <span class="badge"><span class="dot"></span><span id="schCount">0 job(s)</span></span>
          </div>
        </div>

        <div class="controls" style="margin-top:12px;">
          <div class="controls-left" style="width:100%;">
            <label for="schMonth" class="mini-note" style="margin:0;">Bulan</label>
            <select class="select" id="schMonth" title="Pilih bulan kalendar"></select>
            <button class="btn" id="schCurrentMonth" type="button" title="Kembali ke bulan semasa">Current Month</button>
          </div>
          <div class="meta">
            <span id="schMonthInfo" class="sch-month-line">-</span>
          </div>
        </div>

        <div class="sch-wrap">
          <div class="sch-calendar">
            <div class="sch-weekdays">
              <div>Isn</div><div>Sel</div><div>Rab</div><div>Kha</div><div>Jum</div><div>Sab</div><div>Aha</div>
            </div>
            <div id="schGrid" class="sch-days"></div>
            <div class="sch-mini-legend">
              <span><i class="sch-dot sch-dot-assigned"></i>Assigned</span>
              <span><i class="sch-dot sch-dot-progress"></i>In Progress</span>
              <span><i class="sch-dot sch-dot-completed"></i>Completed</span>
              <span><i class="sch-dot sch-dot-holiday"></i>Cuti</span>
              <span><i class="sch-dot sch-dot-salary"></i>Gaji</span>
            </div>
          </div>

          <aside class="sch-side">
            <h3 id="schDayTitle" class="sch-day-title">Pilih satu tarikh</h3>
            <div id="schDayCards" class="sch-card-list">
              <div class="mini-note">Klik mana-mana tarikh bertanda untuk melihat tugasan.</div>
            </div>
          </aside>
        </div>

        <div class="mini-note">
          Tarikh ditanda jika job mempunyai pemeriksa yang ditugaskan dan status adalah Assigned, In Progress, atau Completed.
          Penanda CUTI dan GAJI dipaparkan mengikut data hari cuti Malaysia dan jadual gaji 2026.
          Jika job mempunyai julat tarikh, semua tarikh dalam julat akan ditanda.
        </div>
      </section>
    </section>

    <section class="view" id="viewMap" role="tabpanel" aria-labelledby="tabMap">
      <section class="panel">
        <div class="panel-title">
          <div>
            <h2>Map</h2>
            <p>Blue pins show only In Progress inspections. Heat view shows frequency using all jobs.</p>
          </div>
          <div class="meta">
            <span class="badge"><span class="dot"></span><span id="mapNote">Ready</span></span>
          </div>
        </div>

        <div class="map-wrap">
          <div id="map"></div>
        </div>

        <div class="mini-note">
          ðŸ”µ Pins: In Progress only. Click to view details.<br>
          ðŸ”¥ Heat: workload density based on all jobs (Pending, In Progress, Completed, Cancelled).
        </div>

        <section class="map-completed">
          <h3>Completed Inspections by Negeri</h3>
          <div id="mapCompletedByNegeri" class="mini-note">Loading...</div>
        </section>
      </section>
    </section>
  </main>

  <div class="backdrop" id="backdrop"></div>

  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div class="drawer-title">
        <div class="kicker">Job Detail</div>
        <h2 id="dTitle">JOB</h2>
        <p id="dSub">Select a job to view details</p>
      </div>
      <button class="icon-btn" id="closeDrawer" title="Close">âœ•</button>
    </div>

    <div class="drawer-body">
      <div class="section">
        <h3>Job Info</h3>
        <div class="kv" id="kvJob"></div>
      </div>

      <div class="section">
        <h3>Location</h3>
        <div class="kv" id="kvLoc"></div>
      </div>

      <div class="section">
        <h3>Inspectors</h3>
        <div class="kv" id="kvIns"></div>
        </div>

      <div class="section">
        <h3>Documents</h3>
        <div class="doc-list" id="docList"></div>
      </div>
    </div>
  </aside>

  <div class="modal-wrap" id="profileModal">
    <button class="modal-close" id="closeProfileModal">âœ•</button>
    <div id="profileContent"></div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzyCi-6stLedx0-un55ldx_qOuPgRUrP5A_7nu6uCAINOZvQJatVIzfdowW6Vo02Dby/exec";

  let JOBS = [];                 // All tabs (for Jobs table, schedule, map, etc.)
  let JOBS_PERMOHONAN = [];      // Permohonan only (for Analytics + TAT)
  let INSPECTORS = [];
  let LAST_JOB_IDS = new Set();
  let SCH_MONTH_KEY = "";
  let SCH_SELECTED_DAY = "";
  let SCH_DAY_MAP = new Map();
  const SALARY_DATES_2026 = {
    "2026-01-22": { title: "Tarikh Gaji (Januari)", day: "Khamis", note: "" },
    "2026-02-12": { title: "Tarikh Gaji (Februari)", day: "Khamis", note: "Nota SPANM: Tahun Baharu Cina 17 & 18 Februari 2026 (Selasa & Rabu)." },
    "2026-03-16": { title: "Tarikh Gaji (Mac)", day: "Isnin", note: "Nota SPANM: Hari Raya Puasa 21 & 22 Mac 2026 (Sabtu & Ahad)." },
    "2026-04-20": { title: "Tarikh Gaji (April)", day: "Isnin", note: "" },
    "2026-05-21": { title: "Tarikh Gaji (Mei)", day: "Khamis", note: "Nota SPANM: Hari Raya Haji 27 & 28 Mei 2026 (Rabu & Khamis)." },
    "2026-06-25": { title: "Tarikh Gaji (Jun)", day: "Khamis", note: "" },
    "2026-07-23": { title: "Tarikh Gaji (Julai)", day: "Khamis", note: "" },
    "2026-08-24": { title: "Tarikh Gaji (Ogos)", day: "Isnin", note: "" },
    "2026-09-24": { title: "Tarikh Gaji (September)", day: "Khamis", note: "" },
    "2026-10-22": { title: "Tarikh Gaji (Oktober)", day: "Khamis", note: "" },
    "2026-11-25": { title: "Tarikh Gaji (November)", day: "Rabu", note: "Nota SPANM: Hari Deepavali 8 November 2026 (Ahad)." },
    "2026-12-21": { title: "Tarikh Gaji (Disember)", day: "Isnin", note: "Nota SPANM: Hari Krismas 25 Disember 2026 (Jumaat)." }
  };
  const MALAYSIA_HOLIDAYS_2026 = {
    "2026-01-01": [{ name: "New Year's Day (regional holiday)", note: "Malacca, Negeri Sembilan, Pahang, Penang, Perak, Selangor, Sabah, Sarawak, Kuala Lumpur, Labuan, Putrajaya" }],
    "2026-01-17": [{ name: "Isra and Mi'raj (regional holiday)", note: "Kedah, Negeri Sembilan, Perlis, Terengganu" }],
    "2026-02-01": [
      { name: "Federal Territory Day (regional holiday)", note: "Kuala Lumpur, Labuan, Putrajaya" },
      { name: "Thaipusam (regional holiday)", note: "Johor, Kedah, Negeri Sembilan, Penang, Perak, Selangor, Kuala Lumpur, Putrajaya" }
    ],
    "2026-02-02": [
      { name: "Day off for Thaipusam (regional holiday)", note: "Johor, Kedah, Negeri Sembilan, Penang, Perak, Selangor, Kuala Lumpur, Putrajaya" },
      { name: "Federal Territory Day observed (regional holiday)", note: "Kuala Lumpur, Labuan, Putrajaya" }
    ],
    "2026-02-17": [{ name: "Chinese New Year's Day", note: "Public holiday" }],
    "2026-02-18": [
      { name: "Chinese New Year Holiday (regional holiday)", note: "Kelantan, Terengganu" },
      { name: "Second Day of Chinese New Year (regional holiday)", note: "Johor, Kedah, Malacca, Negeri Sembilan, Pahang, Penang, Perak, Perlis, Selangor, Sabah, Sarawak, Kuala Lumpur, Labuan, Putrajaya" }
    ],
    "2026-02-19": [{ name: "First Day of Ramadan (regional holiday) (tentative)", note: "Johor, Kedah, Malacca" }],
    "2026-03-07": [{ name: "Nuzul Al-Quran (regional holiday)", note: "Kelantan, Pahang, Penang, Perak, Perlis, Selangor, Terengganu, Kuala Lumpur, Labuan, Putrajaya" }],
    "2026-03-20": [{ name: "Hari Raya Puasa (tentative)", note: "Public holiday" }],
    "2026-03-21": [{ name: "Hari Raya Puasa Day 2 (tentative)", note: "Public holiday" }],
    "2026-04-03": [{ name: "Good Friday (regional holiday)", note: "Sabah, Sarawak" }],
    "2026-05-01": [{ name: "Labour Day", note: "Public holiday" }],
    "2026-05-26": [{ name: "Day of Arafat (regional holiday) (tentative)", note: "Kelantan, Terengganu" }],
    "2026-05-27": [{ name: "Hari Raya Haji (tentative)", note: "Public holiday" }],
    "2026-05-28": [{ name: "Hari Raya Haji (Day 2) (regional holiday) (tentative)", note: "Kelantan, Terengganu" }],
    "2026-05-30": [{ name: "Harvest Festival (regional holiday)", note: "Sabah, Labuan" }],
    "2026-05-31": [
      { name: "Second Day of Harvest Festival (regional holiday)", note: "Sabah, Labuan" },
      { name: "Wesak Day", note: "Public holiday" }
    ],
    "2026-06-01": [
      { name: "Second Day of Harvest Festival observed (regional holiday)", note: "Sabah, Labuan" },
      { name: "The Yang di-Pertuan Agong's Birthday", note: "Public holiday" }
    ],
    "2026-06-17": [{ name: "Muharram (tentative)", note: "Public holiday" }],
    "2026-08-25": [{ name: "The Prophet Muhammad's Birthday (tentative)", note: "Public holiday" }],
    "2026-08-31": [{ name: "Malaysia's National Day", note: "Public holiday" }],
    "2026-09-16": [{ name: "Malaysia Day", note: "Public holiday" }],
    "2026-11-08": [{ name: "Diwali (regional holiday)", note: "Johor, Kedah, Kelantan, Malacca, Negeri Sembilan, Pahang, Penang, Perak, Perlis, Sabah, Selangor, Terengganu, Kuala Lumpur, Labuan, Putrajaya" }],
    "2026-12-25": [{ name: "Christmas Day", note: "Public holiday" }]
  };


    const $ = (sel) => document.querySelector(sel);

    const $grid = $("#grid");
    const $count = $("#count");
    const $q = $("#q");
    const $status = $("#statusFilter");
    const $month = $("#monthFilter");
    const $refresh = $("#refresh");

    const $drawer = $("#drawer");
    const $backdrop = $("#backdrop");
    const $close = $("#closeDrawer");
    const $menuDrawer = $("#menuDrawer");
    const $menuBackdrop = $("#menuBackdrop");
    const $menuToggle = $("#menuToggle");
    const $menuClose = $("#menuClose");

    const $statTotal = $("#statTotal");
    const $statPending = $("#statPending");
    const $statProgress = $("#statProgress");
    const $statDone = $("#statDone");
    const $jobsTicker = $("#jobsTicker");
    const $jobsTickerText = $("#jobsTickerText");

    const $dTitle = $("#dTitle");
    const $dSub = $("#dSub");
    const $kvJob = $("#kvJob");
    const $kvLoc = $("#kvLoc");
    const $kvIns = $("#kvIns");
    const $docList = $("#docList");

    const $liveBadge = $("#liveBadge");
    const $liveText = $("#liveText");
    const $newJobBadge = $("#newJobBadge");
    const $newJobText = $("#newJobText");
    const $themeSwitch = $("#themeSwitch");

    const $tabJobs = $("#tabJobs");
    const $tabDir = $("#tabDir");
    const $tabAna = $("#tabAna");
    const $tabTime = $("#tabTime");   // added
    const $tabMap = $("#tabMap");     // added

    const $viewJobs = $("#viewJobs");
    const $viewDir = $("#viewDir");
    const $viewAna = $("#viewAna");
    const $viewTime = $("#viewTime"); // added
    const $viewMap = $("#viewMap");   // added

    const $dirQ = $("#dirQ");
    const $dirSpec = $("#dirSpec");
    const $dirCount = $("#dirCount");
    const $dirGrid = $("#dirGrid");
    const $dirEmpty = $("#dirEmpty");
    const $dirMixChart = $("#dirMixChart");
    const $dirMixLegend = $("#dirMixLegend");
    const $dirMixNote = $("#dirMixNote");
    const $dirLoadChart = $("#dirLoadChart");
    const $dirLoadLegend = $("#dirLoadLegend");
    const $dirLoadNote = $("#dirLoadNote");

    const $aTotal = $("#aTotal");
    const $aRate = $("#aRate");
    const $aTopNegeri = $("#aTopNegeri");
    const $aTopDaerah = $("#aTopDaerah");
    const $copySummary = $("#copySummary");

    const $aStatusChart = $("#aStatusChart");
    const $aStatusLegend = $("#aStatusLegend");
    const $aZoneChart = $("#aZoneChart");
    const $aZoneLegend = $("#aZoneLegend");
    const $aJenisChart = $("#aJenisChart");
    const $aJenisLegend = $("#aJenisLegend");
    const $aLoadChart = $("#aLoadChart");
    const $aLoadLegend = $("#aLoadLegend");

    // Schedule refs
    const $schMonth = $("#schMonth");
    const $schCurrentMonth = $("#schCurrentMonth");
    const $schMonthInfo = $("#schMonthInfo");
    const $schGrid = $("#schGrid");
    const $schCount = $("#schCount");
    const $schDayTitle = $("#schDayTitle");
    const $schDayCards = $("#schDayCards");

    // Map refs (added)
    const $mapNote = $("#mapNote");
    const $mapCompletedByNegeri = $("#mapCompletedByNegeri");

    // Profile Modal refs (Added)
    const $profileModal = $("#profileModal");
    const $profileContent = $("#profileContent");
    const $closeProfileModal = $("#closeProfileModal");
    const THEME_KEY = "ctp_theme";

    function applyTheme(theme){
      const mode = theme === "light" ? "light" : "dark";
      document.body.classList.toggle("theme-light", mode === "light");
      document.body.classList.toggle("theme-dark", mode === "dark");
      if($themeSwitch){
        $themeSwitch.setAttribute("aria-pressed", mode === "dark" ? "true" : "false");
      }
      return mode;
    }

    function initTheme(){
      let stored = "";
      try{
        stored = localStorage.getItem(THEME_KEY) || "";
      }catch(e){}
      applyTheme(stored || "dark");
      if($themeSwitch){
        $themeSwitch.addEventListener("click", () => {
          const isDark = document.body.classList.contains("theme-dark");
          const next = isDark ? "light" : "dark";
          applyTheme(next);
          try{ localStorage.setItem(THEME_KEY, next); }catch(e){}
          if($viewJobs.classList.contains("active")) renderJobs();
          if($viewDir.classList.contains("active")){ rebuildDirectory(); renderDirectory(); }
          if($viewAna.classList.contains("active")) renderAnalytics();
          if($viewTime.classList.contains("active")) renderSchedule();
          if($viewMap.classList.contains("active") && MAP_READY){
            setTimeout(()=> { try{ MAP.invalidateSize(true); } catch(e){} }, 60);
          }
        });
      }
    }

    function toggleMenuDrawer(open){
      if(!$menuDrawer || !$menuBackdrop || !$menuToggle) return;
      $menuDrawer.classList.toggle("open", open);
      $menuBackdrop.classList.toggle("open", open);
      $menuDrawer.setAttribute("aria-hidden", open ? "false" : "true");
      $menuToggle.classList.toggle("is-open", open);
      $menuToggle.setAttribute("aria-expanded", open ? "true" : "false");
    }

    function safe(v){ return (v ?? "").toString().trim(); }
    function normalizeText(s){ return safe(s).toLowerCase().replace(/\s+/g," ").trim(); }
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // ===== PHOTO LOOKUP MAP (Keeps your local assets, maps them to API names) =====
    // Format: "EXACT NAME FROM SHEET": "path/to/photo.jpg"
    const PHOTO_MAP = {
      "NUR FADHILAH BINTI ZULKEPLI": "assets/inspectors/INS_A2_01.jpeg",
      "JAY AZRIN BIN CHE YAHAYA": "assets/inspectors/INS_A2_02.jpeg",
      "AMIR AFIZIE BIN DAUD": "assets/inspectors/INS_A2_03.jpeg",
      "SHAFEE BIN ISHAK": "assets/inspectors/INS_A2_04.jpeg",
      "MOHD AIZAT BIN AYOB": "assets/inspectors/INS_A2_05.jpeg",
      "MOHAMAD FAZWAN BIN ZAKARIA": "assets/inspectors/INS_A2_06.jpeg",
      "MUHAMMAD FAIZAL BIN BATALUMI": "assets/inspectors/INS_A2_07.jpeg",
      "AMIR SYAIFUDIN BIN ISMAIL": "assets/inspectors/INS_A2_08.jpeg",
      "MOHAMAD ZAIDI BIN ABDULLAH": "assets/inspectors/INS_A2_09.jpeg",
      "NAZIRUL HAFIZ BIN ABD SHUKOR": "assets/inspectors/INS_A2_10.jpeg",
      "MUHAMMAD IZZAT BIN ABU ZAHARIN": "assets/inspectors/INS_A2_11.jpeg",
      "MOHAMAD SHARUL IZAM BIN MOHD HAIZENMAN": "assets/inspectors/INS_A2_12.jpeg"
    };

    // Map full names to the short display format you requested
    const SHORT_NAMES = {
      "MOHAMAD ZAIDI BIN ABDULLAH": "SSjn Zaidi",
      "AMIR SYAIFUDIN BIN ISMAIL": "SSjn Amir Syaifudin",
      "AMIR AFIZIE BIN DAUD": "SSjn Amir Afizie",
      "MOHD AIZAT BIN AYOB": "SSjn Aizat",
      "MOHAMAD SHARUL IZAM BIN MOHD HAIZENMAN": "SSjn Sharul",
      "MOHAMAD FAZWAN BIN ZAKARIA": "SSjn Fazwan",
      "MUHAMMAD FAIZAL BIN BATALUMI": "SSjn Faizal",
      "JAY AZRIN BIN CHE YAHAYA": "SSjn Jay",
      "NAZIRUL HAFIZ BIN ABD SHUKOR": "Sjn Nazirul",
      "MUHAMMAD IZZAT BIN ABU ZAHARIN": "Sjn Izzat",
      // Fallbacks for others found in data
      "SHAFEE BIN ISHAK": "SSjn Shafee",
      "NUR FADHILAH BINTI ZULKEPLI": "Kapt Fadhilah"
    };

    function setBadge(mode, text){
      $liveBadge.classList.remove("b-live","b-error","b-loading");
      if(mode === "live") $liveBadge.classList.add("b-live");
      if(mode === "error") $liveBadge.classList.add("b-error");
      if(mode === "loading") $liveBadge.classList.add("b-loading");
      $liveText.textContent = text;
    }

    function setToday(){
      const d = new Date();
      const opt = { year:"numeric", month:"short", day:"2-digit" };
      $("#today").textContent = d.toLocaleDateString(undefined, opt);
    }


    function statusClass(st){
      if(st === "Assigned") return "s-assigned";
      if(st === "Pending") return "s-pending";
      if(st === "In Progress") return "s-progress";
      if(st === "Completed") return "s-done";
      if(st === "Cancelled") return "s-cancel";
      return "";
    }

    function formatDate(raw) {
      if(!raw) return "-";
      const d = new Date(raw);
      if(isNaN(d.getTime())) return safe(raw);
      return d.toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit", year: "numeric" });
    }

    function parseDateSmart(raw){
  const s = safe(raw);
  if(!s) return null;

  // If it's already a Date object
  if(raw instanceof Date) return isNaN(raw.getTime()) ? null : raw;

  // dd/mm/yyyy or dd-mm-yyyy
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m){
    const dd = parseInt(m[1], 10);
    const mm = parseInt(m[2], 10);
    const yyyy = parseInt(m[3], 10);

    // Basic sanity
    if(mm < 1 || mm > 12 || dd < 1 || dd > 31) return null;

    // Construct as local date (midday avoids DST edge weirdness)
    const d = new Date(yyyy, mm - 1, dd, 12, 0, 0, 0);
    return isNaN(d.getTime()) ? null : d;
  }

  // ISO or "Jan 5 2026" etc, let JS try
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

function formatDate(raw){
  const d = parseDateSmart(raw);
  if(!d) return "-";
  return d.toLocaleDateString("en-GB", { day:"2-digit", month:"2-digit", year:"numeric" });
}

    function jobDisplayDate(job){
      const ts = parseDateSmart(job.timestamp);
      if(ts) return formatDate(ts);
      const assign = parseDateSmart(job.tarikhTugasan);
      if(assign) return formatDate(assign);
      const end = parseDateSmart(job.endDate);
      if(end) return formatDate(end);
      return "-";
    }

    function latestJobsByDate(list, count){
      if(!Array.isArray(list) || list.length === 0) return [];
      return [...list]
        .sort((a, b) => {
          const aTime = (parseDateSmart(a.timestamp) || parseDateSmart(a.tarikhTugasan) || parseDateSmart(a.endDate) || new Date(0)).getTime();
          const bTime = (parseDateSmart(b.timestamp) || parseDateSmart(b.tarikhTugasan) || parseDateSmart(b.endDate) || new Date(0)).getTime();
          return bTime - aTime;
        })
        .slice(0, count);
    }

    function updateLatestJobTicker(list){
      if(!$jobsTicker || !$jobsTickerText) return;
      if(!Array.isArray(list) || list.length === 0){
        $jobsTickerText.innerHTML = `<span class="ticker-pill">No jobs available</span>`;
        $jobsTicker.classList.remove("is-new");
        if($newJobBadge) $newJobBadge.style.display = "none";
        LAST_JOB_IDS = new Set();
        return;
      }

      const hadPrev = LAST_JOB_IDS.size > 0;
      const newOnes = hadPrev ? list.filter(j => !LAST_JOB_IDS.has(safe(j.jobId))) : [];
      const chosen = latestJobsByDate(newOnes.length ? newOnes : list, 3);
      const label = newOnes.length ? "Latest new jobs" : "Latest jobs";

      const items = chosen.map(j => {
        const loc = `${safe(j.daerah)}, ${safe(j.negeri)}`.replace(/^,\s*|,\s*$/g, "");
        const dateText = jobDisplayDate(j);
        const line = `${safe(j.jobId) || "JOB"} | ${safe(j.unit) || "-"} | ${safe(j.jenis) || "-"} | ${loc || "-"} | ${dateText}`;
        return `<span class="ticker-pill">${escapeHtml(line)}</span>`;
      });
      const prefix = `<span class="ticker-pill">${escapeHtml(label)}</span>`;
      $jobsTickerText.innerHTML = [prefix, ...items].join('<span class="ticker-sep">|</span>');

      $jobsTicker.classList.toggle("is-new", newOnes.length > 0);
      if($newJobBadge && $newJobText){
        if(newOnes.length > 0){
          $newJobText.textContent = `New: ${newOnes.length}`;
          $newJobBadge.style.display = "inline-flex";
        } else {
          $newJobBadge.style.display = "none";
        }
      }

      LAST_JOB_IDS = new Set(list.map(j => safe(j.jobId)).filter(Boolean));
    }


    function pick(obj, keys){
      for(const k of keys){
        const v = obj?.[k];
        if(v !== undefined && v !== null && safe(v) !== "") return v;
      }
      return "";
    }

    function normalizeStatus(raw){
      const s = safe(raw).toLowerCase();
      if(!s) return "";
      if(s.includes("pending") || s.includes("baharu") || s.includes("baru")) return "Pending";
      if(s.includes("progress") || s.includes("sedang") || s.includes("jalan")) return "In Progress";
      if(s.includes("complete") || s.includes("selesai") || s.includes("tamat")) return "Completed";
      if(s.includes("cancel") || s.includes("batal")) return "Cancelled";
      return safe(raw);
    }

function mapRowToJob(row, sourceTab){
      const jobId = pick(row, ["Job ID","JobID","jobId","JOB ID","ID"]);
      const unit = pick(row, ["Nama pasukan / unit","Nama Pasukan / Unit","Unit","Pasukan","Nama Unit","nama unit"]);
      const jenis = pick(row, ["Jenis pemeriksaan","Jenis Pemeriksaan","jenis","Type","Jenis"]);
      const daerah = pick(row, ["Daerah","daerah"]);
      const negeri = pick(row, ["Negeri","negeri"]);
      const zon = pick(row, ["Zon","zon"]);
      
      // Date fields
      const tarikhTugasan = pick(row, ["Tarikh Tugasan","Tarikh ditugaskan","Assigned Date","Tarikh","tarikh"]);
      const endDate = pick(row, ["End Date", "Tarikh Tamat", "EndDate"]); // <--- NEW
      const timestamp = pick(row, ["Timestamp", "Tarikh Permohonan"]);    // <--- NEW

      const status = normalizeStatus(pick(row, ["Status","status"]));
      const priority = pick(row, ["Priority","Keutamaan","priority"]);

      const assigned1 = pick(row, ["Assigned Inspector 1","Pemeriksa 1","Inspector 1","Pemeriksa Teknikal 1","Assigned 1"]);
      const assigned2 = pick(row, ["Assigned Inspector 2","Pemeriksa 2","Inspector 2","Pemeriksa Teknikal 2","Assigned 2"]);

      const structRaw = pick(row, ["Inspector Structured Data", "Structured Data", "json", "Data Pemeriksaan"]);

      return {
        sourceTab: safe(sourceTab || ""),
        jobId: safe(jobId),
        unit: safe(unit),
        jenis: safe(jenis),
        daerah: safe(daerah),
        negeri: safe(negeri),
        zon: safe(zon),
        tarikhTugasan: safe(tarikhTugasan),
        endDate: safe(endDate),       // <--- NEW
        timestamp: safe(timestamp),   // <--- NEW
        status: safe(status),
        priority: safe(priority),
        assigned1: safe(assigned1),
        assigned2: safe(assigned2),
        inspectorData: safe(structRaw), 
        _raw: row
      };
    }
    function mapRowToInspector(row) {
        const name = pick(row, ["Nama Pemeriksa", "Name", "Inspector Name", "Nama"]);
        const rank = pick(row, ["Pangkat", "Rank", "Gred"]);
        const role = pick(row, ["Penjawatan", "Role"]);
        const spec = pick(row, ["Specialization", "Spec", "Kepakaran"]);
        const zone = pick(row, ["Preferred Zone", "Zon", "Zone"]);
        const phone = pick(row, ["Phone Number", "No Telefon", "Phone"]);
        const email = pick(row, ["Email", "Emel"]);
        const status = pick(row, ["Status", "Availability"]);

        let photo = PHOTO_MAP[name] || "";
        if (!photo) photo = pick(row, ["Photo_URL", "Photo", "Image"]);

        return {
            name: safe(name),
            rank: safe(rank),
            role: safe(role),
            specialization: safe(spec) || "General",
            zone: safe(zone) || "General",
            phone: safe(phone),
            email: safe(email),
            status: safe(status) || "Unknown",
            photo: photo,
            _raw: row
        };
    }

async function loadData() {
  setBadge("loading", "Loading");
  try {
    const base = WEB_APP_URL + (WEB_APP_URL.includes("?") ? "&" : "?");

    // 1. Fetch CTP (Permohonan) Jobs
    const reqJobsCTP = fetch(base + "action=listJobs&tab=permohonan&t=" + Date.now(), {
      method: "GET",
      cache: "no-store"
    }).then(r => r.json());

    // 2. Fetch WDP Jobs
    const reqJobsWDP = fetch(base + "action=listJobs&tab=wdp&t=" + Date.now(), {
      method: "GET",
      cache: "no-store"
    }).then(r => r.json());

    // 3. Fetch FAT Jobs (NEW)
    const reqJobsFAT = fetch(base + "action=listJobs&tab=fat&t=" + Date.now(), {
      method: "GET",
      cache: "no-store"
    }).then(r => r.json());

    // 4. Fetch Inspectors
    const reqInsp = fetch(base + "action=listInspectors&t=" + Date.now(), {
      method: "GET",
      cache: "no-store"
    }).then(r => r.json());

    // Wait for all 4 requests
    const [resCTP, resWDP, resFAT, resInsp] = await Promise.all([reqJobsCTP, reqJobsWDP, reqJobsFAT, reqInsp]);

    const ctpJobs = (resCTP && resCTP.ok && Array.isArray(resCTP.jobs)) ? resCTP.jobs : [];
    const wdpJobs = (resWDP && resWDP.ok && Array.isArray(resWDP.jobs)) ? resWDP.jobs : [];
    const fatJobs = (resFAT && resFAT.ok && Array.isArray(resFAT.jobs)) ? resFAT.jobs : []; // <--- Handle FAT results

    if (!ctpJobs.length && !wdpJobs.length && !fatJobs.length) {
      console.warn("No jobs found across all tabs.");
    }



    // Combine all three lists
// Map each tab separately (so we can filter analytics correctly)
const ctpMapped = ctpJobs
  .map(r => mapRowToJob(r, "Permohonan"))
  .filter(j => safe(j.jobId) !== "");

const wdpMapped = wdpJobs
  .map(r => mapRowToJob(r, "WDP"))
  .filter(j => safe(j.jobId) !== "");

const fatMapped = fatJobs
  .map(r => mapRowToJob(r, "FAT"))
  .filter(j => safe(j.jobId) !== "");

// JOBS = everything (for Jobs view)
JOBS = dedupeByJobId(ctpMapped.concat(wdpMapped).concat(fatMapped));

// âœ… Analytics/TAT only from Permohonan
JOBS_PERMOHONAN = dedupeByJobId(ctpMapped);


if (resInsp && resInsp.ok && Array.isArray(resInsp.inspectors)) {
  INSPECTORS = resInsp.inspectors
    .map((row, idx) => {
      const p = mapRowToInspector(row);
      p._idx = idx; // preserve sheet order
      return p;
    })
    .filter(i => safe(i.name) !== "");
} else {
  console.error("Inspector error", resInsp);
  INSPECTORS = [];
}


    setBadge("live", "Live");
    renderJobs();
    updateLatestJobTicker(JOBS);
    rebuildDirectory();
    renderDirectory();
    renderAnalytics();
    renderCompletedByNegeri();

    renderSchedule(true);
    if ($viewMap.classList.contains("active")) {
      renderMapView();
    } else {
      $mapNote.textContent = "Ready";
    }

  } catch (err) {
    console.error("loadData error:", err);
    setBadge("error", "Offline");
    JOBS = [];
    INSPECTORS = [];
    renderJobs();
    updateLatestJobTicker(JOBS);
    rebuildDirectory();
    renderDirectory();
    renderAnalytics();
    renderSchedule(true);
    $mapNote.textContent = "Offline";
    renderCompletedByNegeri();
  }
}


    function matches(job, q){
      const hay = [
        job.jobId, job.unit, job.jenis, job.daerah, job.negeri, job.zon,
        job.assigned1, job.assigned2, job.status, job.priority
      ].map(safe).join(" ").toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function getVisibleJobs(){
      const q = safe($q.value);
      const st = safe($status.value);
      const m = safe($month ? $month.value : "");

      let list = [...JOBS];
      if(st) list = list.filter(j => safe(j.status) === st);
      if(q) list = list.filter(j => matches(j, q));
      if(m !== ""){
        const mi = parseInt(m, 10);
        list = list.filter(j => {
          const d = parseDateSmart(j.tarikhTugasan) || parseDateSmart(j.timestamp) || parseDateSmart(j.endDate);
          return d ? d.getMonth() === mi : false;
        });
      }
      return list;
    }

    function getPermohonanJobsOnly(){
  return [...JOBS_PERMOHONAN];
}

    function getVisiblePermohonanJobs(){
  const q = safe($q.value);
  const st = safe($status.value);

  let list = [...JOBS_PERMOHONAN];
  if(st) list = list.filter(j => safe(j.status) === st);
  if(q) list = list.filter(j => matches(j, q));
  return list;
}


    function renderStats(list){
      $statTotal.textContent = list.length;
      $statPending.textContent = list.filter(j => j.status === "Pending").length;
      $statProgress.textContent = list.filter(j => j.status === "In Progress").length;
      $statDone.textContent = list.filter(j => j.status === "Completed").length;
    }

   function rowHtml(j){
      const loc = `${safe(j.daerah)}, ${safe(j.negeri)}`.replace(/^,\s*|,\s*$/g, "");
      const stClass = statusClass(j.status);
      
      // Logic for Date Range
const startRaw = safe(j.tarikhTugasan);
const endRaw = safe(j.endDate);

const start = startRaw ? formatDate(startRaw) : "";
const end = endRaw ? formatDate(endRaw) : "";

const dateDisplay = (start && end) ? `${start} - ${end}` : (start || end || "-");


      return `
        <tr>
          <td class="jobid">${escapeHtml(j.jobId)}</td>
          <td>${escapeHtml(j.unit)}</td>
          <td>${escapeHtml(j.jenis)}</td>
          <td>${escapeHtml(loc)}</td>
          <td>${escapeHtml(dateDisplay)}</td> <td>
            <span class="chip ${stClass}">
              <span class="dot"></span>
              ${escapeHtml(j.status || "-")}
            </span>
          </td>
          <td>
            <div class="assignees">
              <div><span>1:</span> <b>${escapeHtml(j.assigned1 || "Unassigned")}</b></div>
              <div><span>2:</span> <b>${escapeHtml(j.assigned2 || "Unassigned")}</b></div>
            </div>
          </td>
          <td>
            <button class="view-btn" data-id="${escapeHtml(j.jobId)}">View</button>
          </td>
        </tr>
      `;
    }


function dedupeByJobId(list){
  const seen = new Set();
  const out = [];
  for(const j of list){
    const id = safe(j.jobId);
    if(!id) continue;
    if(seen.has(id)) continue;
    seen.add(id);
    out.push(j);
  }
  return out;
}



    function renderJobs(){
      const list = getVisibleJobs();
      $grid.innerHTML = list.map(rowHtml).join("");
      $count.textContent = list.length;
      renderStats(list);
    }

    function kvRow(k, v){
      return `<div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(safe(v) || "-")}</div>`;
    }

    // --- ADD THIS NEW FUNCTION ---
    function kvRowHtml(k, v){
      // This version does NOT escape the value 'v', so the link works
      return `<div class="k">${escapeHtml(k)}</div><div class="v">${safe(v) || "-"}</div>`;
    }

    function docRow(name, note, link){
      const has = !!safe(link);
      const href = has ? link : "#";
      const label = has ? "Open" : "None";
      const disabled = has ? "" : "style='opacity:.5; pointer-events:none;'";
      return `
        <div class="doc">
          <div class="left">
            <div class="name">${escapeHtml(name)}</div>
            <div class="note">${escapeHtml(note)}</div>
          </div>
          <a href="${escapeHtml(href)}" target="_blank" rel="noopener" ${disabled}>${escapeHtml(label)}</a>
        </div>
      `;
    }

// --- NEW: Inspector Profile Logic ---
    function openProfile(name) {
      if (!name || name === "Unassigned") return;

      // 1. Find the inspector object in your global INSPECTORS array
      const p = INSPECTORS.find(i => 
        i.name === name || normalizeText(i.name) === normalizeText(name)
      );

      if (!p) {
        alert("Profile details not found for: " + name);
        return;
      }

      // 2. Build the HTML (Reusing the exact design from Directory tab)
      const imgSrc = p.photo ? escapeHtml(p.photo) : "";
      
      // Determine status color
      let stStyle = "background: rgba(255,255,255,.03); color:var(--muted);";
      if(p.status.toLowerCase().includes("aktif") || p.status.toLowerCase() === "active") {
         stStyle = "background: rgba(35,194,107,.15); color:#4ade80;";
      } else if (p.status.toLowerCase().includes("cuti")){
         stStyle = "background: rgba(255,176,32,.15); color:#fbbf24;";
      }

      // Generate Card HTML
      const html = `
        <div class="person" style="border:none;">
          <div class="photo-wrap" style="width:120px; min-width:120px;">
             <img src="${imgSrc}" alt="${escapeHtml(p.name)}" 
             style="width:90px; height:110px;"
             onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22150%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22rgba(255,255,255,.06)%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22rgba(231,238,248,.55)%22 font-family=%22Arial%22 font-size=%2212%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>PHOTO</text></svg>'; this.style.opacity=0.5;" />
          </div>
          <div class="body">
            <div class="top">
              <div style="padding-right:30px;">
                <h3 style="font-size:15px; white-space:normal;">${escapeHtml(p.name)}</h3>
                <div style="font-size:12px; color:var(--muted); margin-top:4px;">${escapeHtml(p.rank)} â€¢ ${escapeHtml(p.role)}</div>
              </div>
            </div>
            
            <div class="tags" style="margin-top:10px;">
              <span class="tag" style="${stStyle}"><b>${escapeHtml(p.status)}</b></span>
              <span class="tag">Specialization: <b>${escapeHtml(p.specialization)}</b></span>
              <span class="tag">Zone: <b>${escapeHtml(p.zone)}</b></span>
            </div>

            <div style="margin-top:12px; font-size:13px; color:var(--text); opacity:.9;">
               ${p.phone ? `<div>ðŸ“ž <a href="tel:${p.phone}" style="color:inherit;">${escapeHtml(p.phone)}</a></div>` : ""}
               ${p.email ? `<div style="font-size:12px; opacity:.7; margin-top:4px;">âœ‰ï¸ ${escapeHtml(p.email)}</div>` : ""}
            </div>
          </div>
        </div>
      `;

      $profileContent.innerHTML = html;
      
      // 3. Show Modal
      $profileModal.classList.add("open");
    }


function openDrawer(job){
      $dTitle.textContent = job.jobId || "JOB";
      $dSub.textContent = `${job.unit} | ${job.jenis}`.replace(/^\s*\|\s*|\s*\|\s*$/g, "");

      // --- DATE & TAT LOGIC ---
      let tarikhPemeriksaanDisplay = "Pemeriksaan belum dilaksanakan";
      let tatDisplay = "-"; // Default if data is missing

      // Parse Inspector Data to get Tarikh Pemeriksaan
      if (job.inspectorData && job.inspectorData.trim() !== "{}" && job.inspectorData.trim() !== "") {
        try {
          const data = JSON.parse(job.inspectorData);
          // Find key containing "tarikh" (case insensitive)
          const dateKey = Object.keys(data).find(k => k.toLowerCase().includes("tarikh"));
          
          if (dateKey && data[dateKey]) {
             // 1. Set Display Date
             tarikhPemeriksaanDisplay = formatDate(data[dateKey]);

             // 2. Calculate TAT (Inspection Date - Application Date)
             if(job.timestamp){
            const appDate = parseDateSmart(job.timestamp);
            const inspDate = parseDateSmart(data[dateKey]);

            if(appDate && inspDate){
            const diffTime = inspDate.getTime() - appDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            tatDisplay = `${diffDays} days`;
            }

                
                if(appDate && inspDate){
                    // Calculate difference in milliseconds
                    const diffTime = inspDate - appDate; 
                    // Convert to days (rounded down)
                    const diff = Math.floor((inspDate.getTime() - appDate.getTime()) / 86400000);
                    tatDisplay = `${diffDays} days`;
                }
             }
          }
        } catch(e) {
          console.error("TAT Calculation Error", e);
        }
      }

      // Existing Date Range Logic for Tarikh Penugasan
      const dateRange = (job.tarikhTugasan && job.endDate) 
        ? `${formatDate(job.tarikhTugasan)} - ${formatDate(job.endDate)}` 
        : formatDate(job.tarikhTugasan);

      // --- RENDER JOB INFO ---
      $kvJob.innerHTML = [
        kvRow("Job ID", job.jobId),
        kvRow("Tarikh Permohonan", formatDate(job.timestamp)),
        kvRow("Unit / Pasukan", job.unit),
        kvRow("Jenis Pemeriksaan", job.jenis),
        kvRow("Priority", job.priority),
        kvRow("Status", job.status),
        kvRow("Tarikh Penugasan", dateRange),
        kvRow("Tarikh Pemeriksaan", tarikhPemeriksaanDisplay),
        kvRow("TAT Compliance", tatDisplay) // <--- NEW FIELD
      ].join("");

      // 2. Location
      $kvLoc.innerHTML = [
        kvRow("Daerah", job.daerah),
        kvRow("Negeri", job.negeri),
        kvRow("Zon", job.zon)
      ].join("");

      // 3. Inspectors (UPDATED to use Links)
      function renderInsLink(name) {
        if (!name || name === "Unassigned") return `<span style="opacity:0.5;">Unassigned</span>`;
        // Only make it clickable if we actually have data for this person
        const exists = INSPECTORS.some(i => normalizeText(i.name) === normalizeText(name));
        if (exists) {
          // Use onclick to trigger the modal
          return `<span class="link-profile" onclick="openProfile('${escapeHtml(name)}')">${escapeHtml(name)}</span>`;
        }
        return escapeHtml(name); // Text only if not found in directory
      }

      $kvIns.innerHTML = [
        kvRowHtml("Inspector 1", renderInsLink(job.assigned1)), // CHANGED TO kvRowHtml
        kvRowHtml("Inspector 2", renderInsLink(job.assigned2))  // CHANGED TO kvRowHtml
      ].join("");

      // 4. HASIL PEMERIKSAAN (Structured Data)
      const $docSection = document.querySelector("#docList").parentElement; 
      $docSection.querySelector("h3").textContent = "HASIL PEMERIKSAAN";
      
      let htmlContent = "";
      
      if (job.inspectorData && job.inspectorData.trim() !== "{}" && job.inspectorData.trim() !== "") {
        try {
          const data = JSON.parse(job.inspectorData);
          
          const submitDate = data.submitDate ? new Date(data.submitDate).toLocaleString() : "";
          
          // Cleanup keys for display
          const displayData = {...data};
          delete displayData.submitDate;
          delete displayData.inspectorStatus;

          const otherRows = Object.entries(displayData).map(([key, val]) => {
            let label = key.replace("Dyn_q_", "").replace(/^./, str => str.toUpperCase());
            let displayVal = val;
            if (!val) displayVal = "-";
            return kvRow(label, displayVal);
          });
          
          htmlContent = `
            <div style="display:flex; flex-direction:column; gap:8px;">
              ${otherRows.join("")} 
              ${submitDate ? `
                <div style="margin-top:12px; padding-top:10px; border-top:1px solid var(--line); color:var(--muted); font-size:11px; text-align:right;">
                  <em>Submitted: ${submitDate}</em>
                </div>
              ` : ""}
            </div>
          `;
          
        } catch (e) {
          htmlContent = `<div style="color:var(--warn); font-size:12px;">Data formatting error.</div>`;
        }
      } else {
        htmlContent = `<div style="color:var(--muted); font-size:12px; font-style:italic;">Belum ada laporan pemeriksaan.</div>`;
      }
      
      $docList.innerHTML = htmlContent;

      $drawer.classList.add("open");
      $backdrop.classList.add("open");
      $drawer.setAttribute("aria-hidden", "false");
    }

    function closeDrawer(){
      $drawer.classList.remove("open");
      $backdrop.classList.remove("open");
      $drawer.setAttribute("aria-hidden", "true");
    }

    function setActiveTab(name){
      const isJobs = name === "jobs";
      const isDir = name === "dir";
      const isAna = name === "ana";
      const isTime = name === "time";
      const isMap = name === "map";

      $tabJobs.classList.toggle("active", isJobs);
      $tabDir.classList.toggle("active", isDir);
      $tabAna.classList.toggle("active", isAna);
      $tabTime.classList.toggle("active", isTime);
      $tabMap.classList.toggle("active", isMap);

      $tabJobs.setAttribute("aria-selected", isJobs ? "true" : "false");
      $tabDir.setAttribute("aria-selected", isDir ? "true" : "false");
      $tabAna.setAttribute("aria-selected", isAna ? "true" : "false");
      $tabTime.setAttribute("aria-selected", isTime ? "true" : "false");
      $tabMap.setAttribute("aria-selected", isMap ? "true" : "false");

      $viewJobs.classList.toggle("active", isJobs);
      $viewDir.classList.toggle("active", isDir);
      $viewAna.classList.toggle("active", isAna);
      $viewTime.classList.toggle("active", isTime);
      $viewMap.classList.toggle("active", isMap);

      if(isDir){
        rebuildDirectory();
        renderDirectory();
      }
      if(isAna){
        renderAnalytics();
      }
      if(isTime){
        renderSchedule();
      }
      if(isMap){
        renderMapView();
      }
    }

    $tabJobs.addEventListener("click", () => setActiveTab("jobs"));
    $tabDir.addEventListener("click", () => setActiveTab("dir"));
    $tabAna.addEventListener("click", () => setActiveTab("ana"));
    $tabTime.addEventListener("click", () => setActiveTab("time"));
    $tabMap.addEventListener("click", () => setActiveTab("map"));

    function buildInspectorBio(spec){
      if(spec === "Documentation"){
        return "Comfortable with admin-heavy workflows. Good at turning messy inputs into clean, audit-ready documents.";
      }
      if(spec === "Automotive"){
        return "Strong on inspection routines and consistency checks. Focused on technical compliance and evidence trail.";
      }
      if(spec === "Sabah/Sarawak Ops"){
        return "Used to the extra friction of travel, timing, and logistics. Efficient at coordinating field checks.";
      }
      if(spec === "Weapon"){
        return "Expertise in weapon systems and armory compliance. Strict adherence to safety protocols.";
      }
      if(spec === "Electronic"){
        return "Specialist in electronic diagnostics, communication systems and technical circuitry.";
      }
      return "Flexible all-rounder. Adapts between site checks and paperwork, keeps things structured.";
    }

    function computeInspectorLoad(jobs){
      const m = new Map();
      jobs.forEach(j=>{
        const a1 = safe(j.assigned1);
        const a2 = safe(j.assigned2);
        [a1,a2].filter(Boolean).forEach(n => m.set(n, (m.get(n)||0) + 1));
      });
      return m;
    }

    function rebuildDirectory(){
      const visibleJobs = getVisibleJobs();
      const loadMapVisible = computeInspectorLoad(visibleJobs);

      INSPECTORS.forEach(p => {
         p.bio = buildInspectorBio(p.specialization);

         let load = loadMapVisible.get(p.name) || 0;

         if(load === 0 && loadMapVisible.size > 0){
             const target = normalizeText(p.name);
             for(const [k,v] of loadMapVisible.entries()){
                 if(normalizeText(k) === target){
                     load = v;
                     break;
                 }
             }
         }
         p.loadVisible = load;
      });

      INSPECTORS.sort((a,b) => (a._idx ?? 0) - (b._idx ?? 0));
    }

    function inspectorMatches(p, q){
      const hay = normalizeText(`${p.name} ${p.specialization} ${p.zone} ${p.bio}`);
      return hay.includes(normalizeText(q));
    }

    function renderDirectory(){
      const q = safe($dirQ.value);
      const spec = safe($dirSpec.value);

      let list = [...INSPECTORS];
      if(spec) list = list.filter(p => safe(p.specialization) === spec);
      if(q) list = list.filter(p => inspectorMatches(p, q));

      $dirCount.textContent = list.length;
      const maxLoad = Math.max(1, ...list.map(p => p.loadVisible || 0));

      if(!list.length){
        $dirGrid.innerHTML = "";
        $dirEmpty.style.display = "block";
      } else {
        $dirEmpty.style.display = "none";
        $dirGrid.innerHTML = list.map(p => {
          const imgSrc = p.photo ? escapeHtml(p.photo) : "";
          const imgTag = `
            <img src="${imgSrc}" alt="${escapeHtml(p.name)}"
              onerror="this.style.opacity=.6; this.src='data:image/svg+xml;utf8,<?xml version=%221.0%22?><svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22150%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22rgba(255,255,255,.06)%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22rgba(231,238,248,.55)%22 font-family=%22Arial%22 font-size=%2212%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>PHOTO</text></svg>';" />
          `;

          let stStyle = "background: rgba(255,255,255,.03); color:var(--muted);";
          if(p.status.toLowerCase().includes("aktif") || p.status.toLowerCase() === "active") {
             stStyle = "background: rgba(35,194,107,.15); color:#4ade80;";
          } else if (p.status.toLowerCase().includes("cuti") || p.status.toLowerCase().includes("kursus")){
             stStyle = "background: rgba(255,176,32,.15); color:#fbbf24;";
          }

          const load = p.loadVisible || 0;
          const pct = Math.round((load / maxLoad) * 100);
          const ratio = maxLoad ? (load / maxLoad) : 0;
          const loadColor = ratio >= 0.7 ? "var(--bad)" : (ratio >= 0.4 ? "var(--warn)" : "var(--good)");

          return `
            <div class="person">
              <div class="photo-wrap">${imgTag}</div>
              <div class="body">
                <div class="top">
                  <div>
                    <h3 title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</h3>
                    <div style="font-size:11px; color:var(--muted); margin-top:2px;">${escapeHtml(p.rank)} â€¢ ${escapeHtml(p.role)}</div>
                  </div>
                  <span class="tag" style="${stStyle}"><b>${escapeHtml(p.status)}</b></span>
                </div>
                <div class="tags" style="margin-top:6px;">
                  <span class="tag">Specialization: <b>${escapeHtml(p.specialization)}</b></span>
                  <span class="tag">Zone: <b>${escapeHtml(p.zone)}</b></span>
                  <span class="tag">Load: <b>${escapeHtml(String(p.loadVisible))}</b></span>
                </div>
                <div class="load-bar" aria-label="Inspector load ${escapeHtml(String(load))}">
                  <div class="load-fill" style="width:${pct}%; background:${loadColor};"></div>
                </div>
                <div class="load-label">Load level</div>
                <div style="margin-top:8px; font-size:13px; color:var(--text); opacity:.9;">
                   ${p.phone ? `<div>ðŸ“ž ${escapeHtml(p.phone)}</div>` : ""}
                   ${p.email ? `<div style="font-size:12px; opacity:.7;">âœ‰ï¸ ${escapeHtml(p.email)}</div>` : ""}
                </div>
              </div>
            </div>
          `;
        }).join("");
      }

      $dirMixNote.textContent = `${list.length} visible`;
      drawBarChart($dirMixChart, countToItems(countBy(list, x => x.specialization)));
      renderLegend($dirMixLegend, countBy(list, x => x.specialization).map(x => x[0]));

      const loadEntries = list
        .map(p => [p.name, p.loadVisible])
        .sort((a,b)=> b[1]-a[1]);

      $dirLoadNote.textContent = `${loadEntries.length} inspectors (visible)`;
      drawBarChart($dirLoadChart, loadEntries.slice(0, 10).map(([k,v]) => ({ label:k, value:v })), true);
      renderLegend($dirLoadLegend, loadEntries.slice(0, 10).map(x => x[0]));
    }

    $dirQ.addEventListener("input", renderDirectory);
    $dirSpec.addEventListener("change", renderDirectory);

    function countBy(arr, getKey){
      const m = new Map();
      arr.forEach(x=>{
        const k = safe(getKey(x)) || "Unknown";
        m.set(k, (m.get(k) || 0) + 1);
      });
      return Array.from(m.entries()).sort((a,b)=> b[1]-a[1]);
    }

    function countToItems(entries){
      return entries.map(([k,v]) => ({ label:k, value:v }));
    }

    function topKey(entries){
      return entries.length ? entries[0][0] : "-";
    }

   function renderAnalytics(){
      const visible = getVisibleJobs();


      // Existing Top Stats
      $aTotal.textContent = visible.length;
      const done = visible.filter(j => j.status === "Completed").length;
      const rate = visible.length ? Math.round((done / visible.length) * 100) : 0;
      $aRate.textContent = rate + "%";

      const byNegeri = countBy(visible, j => j.negeri);
      const byDaerah = countBy(visible, j => j.daerah);
      $aTopNegeri.textContent = topKey(byNegeri);
      $aTopDaerah.textContent = topKey(byDaerah);

      // Existing Charts
      const byStatus = countBy(visible, j => j.status);
      drawBarChart($aStatusChart, countToItems(byStatus));
      renderLegend($aStatusLegend, byStatus.map(x => x[0]));

      const byZone = countBy(visible, j => j.zon);
      drawBarChart($aZoneChart, countToItems(byZone));
      renderLegend($aZoneLegend, byZone.map(x => x[0]));

      const byJenis = countBy(visible, j => j.jenis);
      drawBarChart($aJenisChart, countToItems(byJenis));
      renderLegend($aJenisLegend, byJenis.map(x => x[0]));

      const loadMap = computeInspectorLoad(visible);
      const load = Array.from(loadMap.entries()).sort((a,b)=> b[1]-a[1]);
      drawBarChart($aLoadChart, load.slice(0, 12).map(([k,v]) => ({ label:k, value:v })), true);
      renderLegend($aLoadLegend, load.slice(0, 12).map(x => x[0]));

// --- TAT COMPLIANCE CHART LOGIC (4 BUCKETS) ---
let performing = 0, compliant = 0, marginal = 0, nonCompliant = 0;

const tatJobs = getPermohonanJobsOnly();
console.log("TAT Permohonan jobs:", tatJobs.length, tatJobs.slice(0,3));


tatJobs.forEach(j => {

  if(!j.timestamp) return;
  const appDate = parseDateSmart(j.timestamp);

  let inspDate = null;
  if (j.inspectorData && j.inspectorData.trim() !== "{}" && j.inspectorData.trim() !== "") {
    try {
      const data = JSON.parse(j.inspectorData);
      const k = Object.keys(data).find(key => key.toLowerCase().includes("tarikh"));
      if(k && data[k]) inspDate = parseDateSmart(data[k]);
    } catch(e){}
  }

  if(!inspDate) return;

if(appDate && inspDate){
  const diff = Math.floor((inspDate.getTime() - appDate.getTime()) / 86400000);

  if(diff <= 3) performing++;
  else if(diff <= 7) compliant++;
  else if(diff <= 10) marginal++;
  else nonCompliant++;
}
});

// --- Chart data ---
const tatItems = [
  { label: "Performing (<=3 days)", value: performing, color: "rgba(59,130,246,.55)" },
  { label: "Compliant (4-7 days)", value: compliant, color: "rgba(35,194,107,.55)" },
  { label: "Marginal (8-10 days)", value: marginal, color: "rgba(255,176,32,.55)" },
  { label: "Non-Compliant (>10 days)", value: nonCompliant, color: "rgba(255,77,77,.55)" }
];


      // Draw Chart
      const $aTatChart = $("#aTatChart");
      if($aTatChart) {
          drawBarChart($aTatChart, tatItems);
          
          // Custom Legend for TAT to show colors
          const $aTatLegend = $("#aTatLegend");
          $aTatLegend.innerHTML = tatItems.map(item => `
              <span class="leg">
                  <span class="swatch" style="background:${item.color}; border-color:${item.color}"></span>
                  ${escapeHtml(item.label)}: <b>${item.value}</b>
              </span>
          `).join("");
      }
    }
    $copySummary.addEventListener("click", async ()=>{
      const visible = getVisibleJobs();
      const done = visible.filter(j => j.status === "Completed").length;
      const rate = visible.length ? Math.round((done / visible.length) * 100) : 0;

      const lines = [
        "CT&P Portal Analytics Summary",
        `Visible Jobs: ${visible.length}`,
        `Completed: ${done}`,
        `Completion Rate: ${rate}%`,
        `Top Negeri: ${topKey(countBy(visible, j => j.negeri))}`,
        `Top Daerah: ${topKey(countBy(visible, j => j.daerah))}`,
        "",
        "Status:",
        ...countBy(visible, j => j.status).map(([k,v]) => `- ${k}: ${v}`),
        "",
        "Zon:",
        ...countBy(visible, j => j.zon).map(([k,v]) => `- ${k}: ${v}`),
        "",
        "Jenis Pemeriksaan:",
        ...countBy(visible, j => j.jenis).map(([k,v]) => `- ${k}: ${v}`)
      ];

      const text = lines.join("\n");
      try{
        await navigator.clipboard.writeText(text);
        $copySummary.textContent = "Copied";
        setTimeout(()=> $copySummary.textContent = "Copy summary", 900);
      } catch(e){
        alert(text);
      }
    });

    // ===== Charts (canvas) =====
    function clearCanvas(c){
      const ctx = c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);
      return ctx;
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

// Palette for distinct bar colors (Used for Inspectors)
    const PALETTE = [
      "#3aa0ff", "#23c26b", "#ffb020", "#ff4d4d", "#a855f7",
      "#ec4899", "#14b8a6", "#f97316", "#6366f1", "#8b5cf6",
      "#10b981", "#3b82f6"
    ];

  function drawBarChart(canvas, items, allowLongLabels){
      const ctx = clearCanvas(canvas);
      const w = canvas.width;
      const h = canvas.height;
      const css = getComputedStyle(document.body);
      const chartBg = css.getPropertyValue("--chart-bg").trim() || "rgba(255,255,255,.02)";
      const chartAxis = css.getPropertyValue("--chart-axis").trim() || "rgba(255,255,255,.08)";
      const chartGrid = css.getPropertyValue("--chart-grid").trim() || "rgba(255,255,255,.06)";
      const chartTick = css.getPropertyValue("--chart-tick").trim() || "rgba(231,238,248,.65)";
      const chartValue = css.getPropertyValue("--chart-value").trim() || "rgba(231,238,248,.82)";
      const chartLabel = css.getPropertyValue("--chart-label").trim() || "rgba(159,176,198,.85)";
      const chartBarStroke = css.getPropertyValue("--chart-bar-stroke").trim() || "rgba(255,255,255,.10)";

      const padL = 46;
      const padR = 14;
      const padT = 14;
      const padB = 36; // Reverted to standard padding (no rotation needed)

      const innerW = w - padL - padR;
      const innerH = h - padT - padB;

      ctx.fillStyle = chartBg;
      ctx.fillRect(0,0,w,h);

      const max = Math.max(1, ...items.map(x => x.value || 0));
      const n = Math.max(1, items.length);
      const gap = 10;
      const barW = Math.max(10, (innerW - gap*(n-1)) / n);

      // Axis Line
      ctx.strokeStyle = chartAxis;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + innerH);
      ctx.lineTo(padL + innerW, padT + innerH);
      ctx.stroke();

      // Grid Lines & Labels
      ctx.fillStyle = chartTick;
      ctx.font = "12px Arial";
      const ticks = 4;
      for(let i=0;i<=ticks;i++){
        const t = i/ticks;
        const y = padT + innerH - (innerH*t);
        const val = Math.round(max*t);
        
        ctx.strokeStyle = chartGrid;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + innerW, y);
        ctx.stroke();
        
        ctx.fillText(String(val), 10, y + 4);
      }

      items.forEach((it, i)=>{
        const x = padL + i*(barW + gap);
        const v = it.value || 0;
        const bh = Math.round((v/max) * innerH);
        const y = padT + innerH - bh;

        // Color Logic: Use Custom Color (for TAT) OR Default Gradient (for others)
        if(it.color) {
            ctx.fillStyle = it.color;
        } else {
            const grad = ctx.createLinearGradient(0, y, 0, y + bh);
            grad.addColorStop(0, "rgba(58,160,255,.55)");
            grad.addColorStop(1, "rgba(35,194,107,.28)");
            ctx.fillStyle = grad;
        }

        roundRect(ctx, x, y, barW, bh, 8);
        ctx.fill();

        ctx.strokeStyle = chartBarStroke;
        ctx.stroke();

        // Value on top
        ctx.fillStyle = chartValue;
        ctx.font = "12px Arial";
        const valStr = String(v);
        const textW = ctx.measureText(valStr).width;
        ctx.fillText(valStr, x + (barW - textW)/2, Math.max(14, y - 6));

        // Label handling (Short Name Lookup)
        ctx.fillStyle = chartLabel;
        ctx.font = "11px Arial";
        
        let lab = String(it.label || "Unknown");
        // Check if there is a short name mapping, otherwise keep original
        if(SHORT_NAMES && SHORT_NAMES[lab]) {
            lab = SHORT_NAMES[lab];
        }

        // Simple truncation if still too long
        const short = (lab.length > 15 && !allowLongLabels) ? lab.slice(0,14)+"â€¦" : lab;
        
        // Center the text
        const labW = ctx.measureText(short).width;
        ctx.fillText(short, x + (barW - labW)/2, padT + innerH + 22);
      });
    }
    
    function renderLegend(el, labels){
      el.innerHTML = (labels || []).slice(0, 12).map(l => `<span class="leg"><span class="swatch"></span>${escapeHtml(l)}</span>`).join("");
      if(!el.innerHTML) el.innerHTML = `<span class="leg"><span class="swatch"></span>None</span>`;
    }

    // ===== Events =====
    $q.addEventListener("input", () => {
      renderJobs();
      rebuildDirectory();
      if($viewTime.classList.contains("active")) renderSchedule();
    });
    $status.addEventListener("change", () => {
      renderJobs();
      rebuildDirectory();
      if($viewTime.classList.contains("active")) renderSchedule();
    });
    if($month) $month.addEventListener("change", () => {
      renderJobs();
      rebuildDirectory();
      if($viewTime.classList.contains("active")) renderSchedule();
    });
    $refresh.addEventListener("click", loadData);
    $closeProfileModal.addEventListener("click", () => { $profileModal.classList.remove("open"); });

    $grid.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-id]");
      if(!btn) return;
      const id = btn.getAttribute("data-id");
      const job = JOBS.find(j => j.jobId === id);
      if(job) openDrawer(job);
    });

    $close.addEventListener("click", closeDrawer);
    $backdrop.addEventListener("click", closeDrawer);
    if($menuToggle) $menuToggle.addEventListener("click", () => {
      const open = !$menuDrawer.classList.contains("open");
      toggleMenuDrawer(open);
    });
    if($menuClose) $menuClose.addEventListener("click", () => toggleMenuDrawer(false));
    if($menuBackdrop) $menuBackdrop.addEventListener("click", () => toggleMenuDrawer(false));
    if($menuDrawer){
      $menuDrawer.querySelectorAll("a").forEach(a => {
        a.addEventListener("click", () => toggleMenuDrawer(false));
      });
    }
    if($mapCompletedByNegeri){
      $mapCompletedByNegeri.addEventListener("click", (e) => {
        const btn = e.target.closest(".map-ins-link");
        if(!btn) return;
        const name = safe(btn.getAttribute("data-inspector"));
        if(name) openProfile(name);
      });
    }
    if($schDayCards){
      $schDayCards.addEventListener("click", (e) => {
        const btn = e.target.closest(".sch-ins-link");
        if(!btn) return;
        const name = safe(btn.getAttribute("data-inspector"));
        if(name) openProfile(name);
      });
    }

    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        closeDrawer();
        toggleMenuDrawer(false);
      }
    });    // ===== Schedule =====
    function pad2(n){ return String(n).padStart(2, "0"); }
    function toDayKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function toMonthKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }

    function monthLabelFromKey(key){
      const m = String(key || "").match(/^(\d{4})-(\d{2})$/);
      if(!m) return key || "-";
      const y = Number(m[1]);
      const mon = Number(m[2]) - 1;
      const d = new Date(y, mon, 1, 12, 0, 0, 0);
      if(isNaN(d.getTime())) return key || "-";
      return d.toLocaleDateString("en-GB", { month:"long", year:"numeric" });
    }

    function parseMonthKey(key){
      const m = String(key || "").match(/^(\d{4})-(\d{2})$/);
      if(!m) return null;
      const y = Number(m[1]);
      const mon = Number(m[2]);
      if(!Number.isFinite(y) || !Number.isFinite(mon) || mon < 1 || mon > 12) return null;
      return { y, mon };
    }

    function getHolidayEvents(dayKey){
      return MALAYSIA_HOLIDAYS_2026[dayKey] || [];
    }

    function getSalaryEvent(dayKey){
      return SALARY_DATES_2026[dayKey] || null;
    }

    function getSpecialDaySet(monthKey){
      const set = new Set();
      Object.keys(MALAYSIA_HOLIDAYS_2026).forEach(k => {
        if(k.startsWith(monthKey + "-")) set.add(k);
      });
      Object.keys(SALARY_DATES_2026).forEach(k => {
        if(k.startsWith(monthKey + "-")) set.add(k);
      });
      return set;
    }

    function renderScheduleInspectorLink(name){
      const n = safe(name);
      if(!n || normalizeText(n) === "unassigned" || n === "-"){
        return `<span style="opacity:.5;">Unassigned</span>`;
      }
      const exists = INSPECTORS.some(i => normalizeText(i.name) === normalizeText(n));
      if(exists){
        return `<button type="button" class="sch-ins-link" data-inspector="${escapeHtml(n)}">${escapeHtml(n)}</button>`;
      }
      return escapeHtml(n);
    }

    function scheduleStatusBucket(status){
      const s = normalizeText(status);
      if(!s) return "";
      if(s.includes("completed") || s.includes("selesai")) return "completed";
      if(s.includes("in progress") || s.includes("progress")) return "progress";
      if(s.includes("assigned") || s.includes("ditugas")) return "assigned";
      return "";
    }

    function hasAssignedInspector(job){
      const a1 = normalizeText(job.assigned1);
      const a2 = normalizeText(job.assigned2);
      const invalid = new Set(["", "-", "none", "unassigned"]);
      return !invalid.has(a1) || !invalid.has(a2);
    }

    function scheduleDateRange(job){
      let start = parseDateSmart(job.tarikhTugasan) || parseDateSmart(job.timestamp);
      if(!start) return null;
      let end = parseDateSmart(job.endDate) || start;
      start = new Date(start.getFullYear(), start.getMonth(), start.getDate(), 12, 0, 0, 0);
      end = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 12, 0, 0, 0);
      if(end.getTime() < start.getTime()){
        const tmp = start;
        start = end;
        end = tmp;
      }
      return { start, end };
    }

    function expandDayKeys(start, end){
      const out = [];
      const cur = new Date(start.getFullYear(), start.getMonth(), start.getDate(), 12, 0, 0, 0);
      const last = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 12, 0, 0, 0);
      for(let i = 0; i < 370 && cur.getTime() <= last.getTime(); i++){
        out.push(toDayKey(cur));
        cur.setDate(cur.getDate() + 1);
      }
      return out;
    }

    function getSchedulableJobs(){
      return JOBS.filter(j => {
        const bucket = scheduleStatusBucket(j.status);
        if(!bucket) return false;
        if(!hasAssignedInspector(j)) return false;
        return !!scheduleDateRange(j);
      });
    }

    function getScheduleMonthKeys(){
      const nowKey = toMonthKey(new Date());
      const set = new Set([nowKey]);
      getSchedulableJobs().forEach(j => {
        const range = scheduleDateRange(j);
        if(!range) return;
        const from = new Date(range.start.getFullYear(), range.start.getMonth(), 1, 12, 0, 0, 0);
        const to = new Date(range.end.getFullYear(), range.end.getMonth(), 1, 12, 0, 0, 0);
        for(let i = 0, cur = new Date(from); i < 60 && cur.getTime() <= to.getTime(); i++){
          set.add(toMonthKey(cur));
          cur.setMonth(cur.getMonth() + 1);
        }
      });
      return Array.from(set).sort((a,b) => a < b ? 1 : -1);
    }

    function renderScheduleMonthOptions(forceCurrent=false){
      if(!$schMonth) return;
      const nowKey = toMonthKey(new Date());
      const keys = getScheduleMonthKeys();
      $schMonth.innerHTML = keys.map(k => `<option value="${escapeHtml(k)}">${escapeHtml(monthLabelFromKey(k))}</option>`).join("");
      if(forceCurrent || !SCH_MONTH_KEY || !keys.includes(SCH_MONTH_KEY)){
        SCH_MONTH_KEY = keys.includes(nowKey) ? nowKey : (keys[0] || nowKey);
      }
      const hasSelected = Array.from($schMonth.options || []).some(o => safe(o.value) === SCH_MONTH_KEY);
      if(!hasSelected){
        SCH_MONTH_KEY = keys[0] || nowKey;
      }
      $schMonth.value = SCH_MONTH_KEY;
    }

    function buildScheduleDayMap(monthKey){
      const map = new Map();
      const monthJobs = new Map();
      getSchedulableJobs().forEach(j => {
        const bucket = scheduleStatusBucket(j.status);
        const range = scheduleDateRange(j);
        if(!bucket || !range) return;
        const dayKeys = expandDayKeys(range.start, range.end);
        dayKeys.forEach(k => {
          if(!k.startsWith(monthKey + "-")) return;
          if(!map.has(k)){
            map.set(k, { jobs: [], statuses: new Set(), counts: { assigned: 0, progress: 0, completed: 0 } });
          }
          const rec = map.get(k);
          rec.jobs.push(j);
          rec.statuses.add(bucket);
          rec.counts[bucket] = (rec.counts[bucket] || 0) + 1;
          monthJobs.set(safe(j.jobId), j);
        });
      });
      return { map, monthJobs: Array.from(monthJobs.values()) };
    }

    function statusOrderForSchedule(st){
      const bucket = scheduleStatusBucket(st);
      if(bucket === "progress") return 0;
      if(bucket === "assigned") return 1;
      if(bucket === "completed") return 2;
      return 9;
    }

    function renderScheduleDayCards(dayKey){
      if(!$schDayCards || !$schDayTitle) return;
      const dateObj = parseDateSmart(dayKey);
      const pretty = dateObj ? dateObj.toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" }) : "-";
      const rec = SCH_DAY_MAP.get(dayKey);
      const holidays = getHolidayEvents(dayKey);
      const salary = getSalaryEvent(dayKey);
      const jobs = rec && Array.isArray(rec.jobs) ? rec.jobs : [];

      const list = [...jobs].sort((a, b) => {
        const byStatus = statusOrderForSchedule(a.status) - statusOrderForSchedule(b.status);
        if(byStatus !== 0) return byStatus;
        return safe(a.jobId).localeCompare(safe(b.jobId));
      });

      const badges = [];
      if(holidays.length) badges.push(`${holidays.length} cuti`);
      if(salary) badges.push("hari gaji");
      $schDayTitle.textContent = `${pretty} (${list.length} job${list.length === 1 ? "" : "s"}${badges.length ? `, ${badges.join(", ")}` : ""})`;

      const specialBlocks = [];
      if(holidays.length){
        specialBlocks.push(`
          <section class="sch-special-card">
            <h4 class="sch-special-title">Cuti Malaysia</h4>
            ${holidays.map(h => `
              <div class="sch-special-row">
                <b>${escapeHtml(h.name || "Public Holiday")}</b>
                ${h.note ? `<div style="color:var(--muted); margin-top:2px;">${escapeHtml(h.note)}</div>` : ""}
              </div>
            `).join("")}
          </section>
        `);
      }
      if(salary){
        specialBlocks.push(`
          <section class="sch-special-card">
            <h4 class="sch-special-title">Tarikh Pembayaran Emolumen</h4>
            <div class="sch-special-row"><b>${escapeHtml(salary.title || "Tarikh Gaji")}</b></div>
            <div class="sch-special-row">Hari: ${escapeHtml(salary.day || "-")}</div>
            ${salary.note ? `<div class="sch-special-row" style="color:var(--muted);">${escapeHtml(salary.note)}</div>` : ""}
          </section>
        `);
      }

      const jobCards = list.map(j => {
        const loc = `${safe(j.daerah)}, ${safe(j.negeri)}`.replace(/^,\s*|,\s*$/g, "");
        const assignedHtml = [
          renderScheduleInspectorLink(j.assigned1),
          renderScheduleInspectorLink(j.assigned2)
        ].join(" / ");
        const start = formatDate(j.tarikhTugasan);
        const end = formatDate(j.endDate);
        const range = (safe(j.endDate) && safe(j.endDate) !== safe(j.tarikhTugasan)) ? `${start} - ${end}` : start;
        const chipClass = statusClass(j.status) || (scheduleStatusBucket(j.status) === "assigned" ? "s-assigned" : "");
        return `
          <article class="sch-card">
            <div class="sch-card-top">
              <div>
                <div class="sch-card-id">${escapeHtml(safe(j.jobId) || "JOB")}</div>
                <div class="sch-card-unit">${escapeHtml(safe(j.unit) || "-")}</div>
              </div>
              <span class="chip ${chipClass}">
                <span class="dot"></span>${escapeHtml(safe(j.status) || "-")}
              </span>
            </div>
            <div class="sch-card-sub"><b>Jenis:</b> ${escapeHtml(safe(j.jenis) || "-")}</div>
            <div class="sch-card-sub"><b>Pemeriksa:</b> ${assignedHtml}</div>
            <div class="sch-card-sub"><b>Lokasi:</b> ${escapeHtml(loc || "-")} (${escapeHtml(safe(j.zon) || "-")})</div>
            <div class="sch-card-sub"><b>Tarikh:</b> ${escapeHtml(range || "-")}</div>
          </article>
        `;
      }).join("");

      if(!specialBlocks.length && !jobCards){
        $schDayCards.innerHTML = `<div class="mini-note">Tiada tugasan dijadualkan pada tarikh ini.</div>`;
        return;
      }
      $schDayCards.innerHTML = specialBlocks.join("") + jobCards;
    }

    function renderScheduleCalendar(){
      if(!$schGrid) return;
      const parsed = parseMonthKey(SCH_MONTH_KEY);
      if(!parsed){
        $schGrid.innerHTML = `<div class="mini-note">Bulan tidak sah.</div>`;
        if($schDayCards) $schDayCards.innerHTML = `<div class="mini-note">Tiada data.</div>`;
        if($schCount) $schCount.textContent = "0 job(s)";
        return;
      }

      const { y, mon } = parsed;
      const first = new Date(y, mon - 1, 1, 12, 0, 0, 0);
      const daysInMonth = new Date(y, mon, 0, 12, 0, 0, 0).getDate();
      const offset = (first.getDay() + 6) % 7;

      const built = buildScheduleDayMap(SCH_MONTH_KEY);
      SCH_DAY_MAP = built.map;
      const specialDaySet = getSpecialDaySet(SCH_MONTH_KEY);
      if($schCount) $schCount.textContent = `${built.monthJobs.length} job(s)`;
      if($schMonthInfo) $schMonthInfo.textContent = monthLabelFromKey(SCH_MONTH_KEY);

      const todayKey = toDayKey(new Date());
      if(!SCH_SELECTED_DAY || !SCH_SELECTED_DAY.startsWith(SCH_MONTH_KEY + "-")){
        const hasTodayJob = SCH_DAY_MAP.has(todayKey);
        const hasTodaySpecial = specialDaySet.has(todayKey);
        if(todayKey.startsWith(SCH_MONTH_KEY + "-") && (hasTodayJob || hasTodaySpecial)){
          SCH_SELECTED_DAY = todayKey;
        }else{
          const marked = new Set([...SCH_DAY_MAP.keys(), ...specialDaySet]);
          if(marked.size > 0){
            SCH_SELECTED_DAY = Array.from(marked).sort()[0];
          }else{
            SCH_SELECTED_DAY = `${SCH_MONTH_KEY}-01`;
          }
        }
      }
      if(!SCH_SELECTED_DAY.startsWith(SCH_MONTH_KEY + "-")){
        const marked = new Set([...SCH_DAY_MAP.keys(), ...specialDaySet]);
        if(marked.size > 0){
          SCH_SELECTED_DAY = Array.from(marked).sort()[0];
        }else{
          SCH_SELECTED_DAY = `${SCH_MONTH_KEY}-01`;
        }
      }

      const cells = [];
      for(let i=0; i<offset; i++){
        cells.push(`<button class="sch-day out" type="button" tabindex="-1" aria-hidden="true"></button>`);
      }

      for(let d=1; d<=daysInMonth; d++){
        const dayKey = `${SCH_MONTH_KEY}-${pad2(d)}`;
        const rec = SCH_DAY_MAP.get(dayKey);
        const holidays = getHolidayEvents(dayKey);
        const salary = getSalaryEvent(dayKey);
        const hasHoliday = holidays.length > 0;
        const hasSalary = !!salary;
        const statuses = rec ? Array.from(rec.statuses) : [];
        const count = rec ? rec.jobs.length : 0;
        const dots = [
          statuses.includes("assigned") ? `<i class="sch-dot sch-dot-assigned"></i>` : "",
          statuses.includes("progress") ? `<i class="sch-dot sch-dot-progress"></i>` : "",
          statuses.includes("completed") ? `<i class="sch-dot sch-dot-completed"></i>` : "",
          hasHoliday ? `<i class="sch-dot sch-dot-holiday"></i>` : "",
          hasSalary ? `<i class="sch-dot sch-dot-salary"></i>` : ""
        ].join("");
        const flags = [
          hasHoliday ? `<span class="sch-flag sch-flag-h">CUTI</span>` : "",
          hasSalary ? `<span class="sch-flag sch-flag-s">GAJI</span>` : ""
        ].join("");
        const classes = [
          "sch-day",
          (rec || hasHoliday || hasSalary) ? "has-jobs" : "",
          dayKey === SCH_SELECTED_DAY ? "selected" : "",
          dayKey === todayKey ? "today" : ""
        ].filter(Boolean).join(" ");
        cells.push(`
          <button class="${classes}" type="button" data-day="${escapeHtml(dayKey)}" aria-label="${escapeHtml(dayKey)}">
            <span class="sch-num">${d}</span>
            ${flags ? `<span class="sch-flags">${flags}</span>` : ""}
            <span class="sch-markers">${dots}${count ? `<span class="sch-count">${count}</span>` : ""}</span>
          </button>
        `);
      }

      const totalCells = Math.ceil(cells.length / 7) * 7;
      for(let i=cells.length; i<totalCells; i++){
        cells.push(`<button class="sch-day out" type="button" tabindex="-1" aria-hidden="true"></button>`);
      }

      $schGrid.innerHTML = cells.join("");
      renderScheduleDayCards(SCH_SELECTED_DAY);
    }

    function renderSchedule(forceCurrentMonth=false){
      if(!$schMonth || !$schGrid || !$schDayCards) return;
      renderScheduleMonthOptions(forceCurrentMonth);
      renderScheduleCalendar();
    }

    if($schGrid){
      $schGrid.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-day]");
        if(!btn) return;
        const day = safe(btn.getAttribute("data-day"));
        if(!day) return;
        SCH_SELECTED_DAY = day;
        renderScheduleCalendar();
      });
    }
    if($schMonth){
      $schMonth.addEventListener("change", () => {
        SCH_MONTH_KEY = safe($schMonth.value);
        SCH_SELECTED_DAY = "";
        renderScheduleCalendar();
      });
    }
    if($schCurrentMonth){
      $schCurrentMonth.addEventListener("click", () => {
        SCH_MONTH_KEY = toMonthKey(new Date());
        SCH_SELECTED_DAY = "";
        renderSchedule(true);
      });
    }

    // ===== Map (added) =====
    let MAP = null;
    let MAP_READY = false;
    let PIN_LAYER = null;
    let HEAT_LAYER = null;

    // simple local cache to avoid slamming geocoder
    const GEO_MEM = new Map();
    const GEO_KEY = "ctp_geo_cache_v1";

    function loadGeoCache(){
      try{
        const raw = localStorage.getItem(GEO_KEY);
        if(!raw) return;
        const obj = JSON.parse(raw);
        Object.keys(obj).forEach(k=>{
          const v = obj[k];
          if(v && typeof v.lat === "number" && typeof v.lon === "number"){
            GEO_MEM.set(k, [v.lat, v.lon]);
          }
        });
      } catch(e){}
    }

    function saveGeoCache(){
      try{
        const obj = {};
        for(const [k,v] of GEO_MEM.entries()){
          obj[k] = { lat: v[0], lon: v[1] };
        }
        localStorage.setItem(GEO_KEY, JSON.stringify(obj));
      } catch(e){}
    }

    async function geocodeNominatim(query){
      const key = normalizeText(query);
      if(GEO_MEM.has(key)) return GEO_MEM.get(key);

      const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(query);
      const res = await fetch(url, { method:"GET" });
      const data = await res.json();

      if(Array.isArray(data) && data[0] && data[0].lat && data[0].lon){
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        if(!isNaN(lat) && !isNaN(lon)){
          const val = [lat, lon];
          GEO_MEM.set(key, val);
          return val;
        }
      }
      return null;
    }

    // small concurrency limiter so map loads reliably
    async function mapWithConcurrency(items, limit, fn){
      const out = new Array(items.length);
      let idx = 0;
      const workers = new Array(Math.min(limit, items.length)).fill(0).map(async ()=>{
        while(idx < items.length){
          const i = idx++;
          out[i] = await fn(items[i], i);
        }
      });
      await Promise.all(workers);
      return out;
    }

    function ensureMap(){
      if(MAP_READY) return;

      loadGeoCache();

      MAP = L.map("map", { zoomControl:true }).setView([4.2105, 101.9758], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "Â© OpenStreetMap"
      }).addTo(MAP);

      PIN_LAYER = L.layerGroup().addTo(MAP);
      MAP_READY = true;
    }

   function pinPopupHtml(job){
      const p1 = PHOTO_MAP[job.assigned1] || "";
      const p2 = PHOTO_MAP[job.assigned2] || "";

      // Logic for Date Range
      const start = formatDate(job.tarikhTugasan);
      const end = formatDate(job.endDate);
      const dateDisplay = (start && end) ? `${start} - ${end}` : (start || "-");

      const img = (src, name) => `
        <img src="${escapeHtml(src)}" alt="${escapeHtml(name)}" 
          style="width:42px;height:52px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:var(--surface-soft);"
          onerror="this.style.display='none';" />
      `;

      const loc = `${safe(job.daerah)}, ${safe(job.negeri)}`.replace(/^,\s*|,\s*$/g, "");

      return `
        <div style="min-width:240px;">
          <div style="font-weight:1000; letter-spacing:.2px;">${escapeHtml(job.unit || "-")}</div>
          <div style="color:var(--muted); font-size:12px; margin-top:2px;">${escapeHtml(job.jenis || "-")}</div>
          <div style="color:var(--muted); font-size:12px; margin-top:6px;">ðŸ“ ${escapeHtml(loc || "-")}</div>
          <div style="color:var(--text); font-size:12px; margin-top:4px; font-weight:700;">ðŸ“… ${escapeHtml(dateDisplay)}</div>

          <div style="display:flex; gap:10px; margin-top:10px; align-items:flex-start;">
            <div style="display:flex; gap:6px;">
              ${p1 ? img(p1, job.assigned1) : ""}
              ${p2 ? img(p2, job.assigned2) : ""}
            </div>
            <div style="font-size:12px; line-height:1.35;">
              <div><b>1:</b> ${escapeHtml(job.assigned1 || "Unassigned")}</div>
              <div><b>2:</b> ${escapeHtml(job.assigned2 || "Unassigned")}</div>
              <div style="margin-top:6px; color:var(--accent); font-weight:900;">In Progress</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderCompletedByNegeri(){
      if(!$mapCompletedByNegeri) return;

      const completed = JOBS.filter(j => safe(j.status) === "Completed" && safe(j.negeri));
      if(!completed.length){
        $mapCompletedByNegeri.innerHTML = `<div class="mini-note">No completed inspections found.</div>`;
        return;
      }

      const byNegeri = new Map();
      completed.forEach(j => {
        const negeri = safe(j.negeri);
        if(!byNegeri.has(negeri)){
          byNegeri.set(negeri, { jobs: 0, inspectors: new Map() });
        }
        const bucket = byNegeri.get(negeri);
        bucket.jobs++;

        [safe(j.assigned1), safe(j.assigned2)].forEach(name => {
          if(!name || normalizeText(name) === "unassigned") return;
          bucket.inspectors.set(name, (bucket.inspectors.get(name) || 0) + 1);
        });
      });

      const negeriRows = Array.from(byNegeri.entries())
        .sort((a, b) => a[0].localeCompare(b[0]));

      $mapCompletedByNegeri.innerHTML = negeriRows.map(([negeri, data], idx) => {
        const inspectors = Array.from(data.inspectors.entries())
          .sort((a, b) => a[0].localeCompare(b[0]));

        const listHtml = inspectors.length
          ? `<ul class="map-ins-list">${
              inspectors.map(([name, count]) => `
                <li class="map-ins-item">
                  <button type="button" class="map-ins-link" data-inspector="${escapeHtml(name)}">${escapeHtml(name)}</button>
                  <span class="map-ins-count">${count} job${count > 1 ? "s" : ""}</span>
                </li>
              `).join("")
            }</ul>`
          : `<div class="mini-note" style="padding:0 12px 10px;">No assigned inspectors in completed jobs.</div>`;

        return `
          <details class="map-state" ${idx === 0 ? "open" : ""}>
            <summary>
              <span>${escapeHtml(negeri)}</span>
              <span class="map-state-meta">${data.jobs} completed - ${inspectors.length} inspectors</span>
            </summary>
            ${listHtml}
          </details>
        `;
      }).join("");
    }

    async function renderMapView(){
      try{
        $mapNote.textContent = "Loading";
        renderCompletedByNegeri();
        ensureMap();

        // Leaflet needs a resize after the tab becomes visible
        setTimeout(()=> { try{ MAP.invalidateSize(true); } catch(e){} }, 60);

        PIN_LAYER.clearLayers();
        if(HEAT_LAYER){
          MAP.removeLayer(HEAT_LAYER);
          HEAT_LAYER = null;
        }

        // Heat uses all jobs (Option 1)
        const locCount = new Map();
        const locKey = (j) => normalizeText(`${safe(j.daerah)}|${safe(j.negeri)}`);
        JOBS.forEach(j=>{
          if(!safe(j.daerah) || !safe(j.negeri)) return;
          const k = locKey(j);
          locCount.set(k, (locCount.get(k)||0) + 1);
        });

        const uniqueLocs = Array.from(locCount.keys()).map(k=>{
          const parts = k.split("|");
          return {
            key: k,
            query: `${parts[0]}, ${parts[1]}, Malaysia`,
            count: locCount.get(k) || 1
          };
        });

        const geoHeat = await mapWithConcurrency(uniqueLocs, 2, async (it)=>{
          const pos = await geocodeNominatim(it.query);
          if(!pos) return null;
          // weight based on frequency
          const w = Math.min(1, 0.25 + Math.log(it.count + 1) / 3);
          return [pos[0], pos[1], w];
        });

        const heatPoints = geoHeat.filter(Boolean);
        HEAT_LAYER = L.heatLayer(heatPoints, { radius: 28, blur: 22, maxZoom: 9 }).addTo(MAP);

        // Pins only for In Progress
        const active = JOBS.filter(j => safe(j.status) === "In Progress" && safe(j.daerah) && safe(j.negeri));

        const geoPins = await mapWithConcurrency(active, 2, async (j)=>{
          const query = `${safe(j.daerah)}, ${safe(j.negeri)}, Malaysia`;
          const pos = await geocodeNominatim(query);
          return pos ? { job:j, pos } : null;
        });

        const pinItems = geoPins.filter(Boolean);

        pinItems.forEach(({job, pos})=>{
          const marker = L.circleMarker(pos, {
            radius: 9,
            color: "#3aa0ff",
            weight: 2,
            fillColor: "#3aa0ff",
            fillOpacity: 0.82
          });
          marker.bindPopup(pinPopupHtml(job), { maxWidth: 360, closeButton: true });
          marker.addTo(PIN_LAYER);
        });

        saveGeoCache();
        $mapNote.textContent = `${pinItems.length} active pins`;
      } catch(e){
        console.error("renderMapView error", e);
        $mapNote.textContent = "Error";
        renderCompletedByNegeri();
      }
    }

    // ===== Added: keep existing job filters, while schedule remains independent =====

    initTheme();
    setToday();
    loadData();
  </script>
</body>
</html>
