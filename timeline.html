<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CT&P | Competency Tracker</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; color: #334155; }
    .mono { font-family: 'JetBrains Mono', monospace; }

    /* ANIMATIONS */
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card-anim { animation: slideIn 0.3s ease-out forwards; opacity: 0; }

    /* TIMELINE CONNECTOR STYLES */
    .timeline-line {
      height: 2px;
      flex-grow: 1;
      position: relative;
      margin: 0 15px;
      border-radius: 2px;
    }
    
    /* The "Days Taken" Bubble */
    .days-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 800;
      white-space: nowrap;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
    }

    /* STATUS COLORS */
    .status-fast .timeline-line { background: #10b981; } /* Green */
    .status-fast .days-badge { background: #d1fae5; color: #047857; }
    
    .status-avg .timeline-line { background: #f59e0b; } /* Orange */
    .status-avg .days-badge { background: #fef3c7; color: #b45309; }
    
    .status-slow .timeline-line { background: #ef4444; } /* Red */
    .status-slow .days-badge { background: #fee2e2; color: #b91c1c; }
    
    .status-pending .timeline-line { background: #cbd5e1; border-top: 2px dashed #94a3b8; background: transparent; }
    .status-pending .days-badge { background: #f1f5f9; color: #64748b; }

    /* CUSTOM SCROLLBAR */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col">

  <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
      
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
          <i class="fa-solid fa-stopwatch text-lg"></i>
        </div>
        <div>
          <h1 class="font-extrabold text-xl text-slate-800 tracking-tight">COMPETENCY TRACKER</h1>
          <p class="text-xs text-slate-400 font-medium">Monitoring Inspection Efficiency</p>
        </div>
      </div>

      <div class="flex gap-4">
         <div class="bg-slate-50 border border-slate-100 px-4 py-2 rounded-lg text-center">
            <div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Avg Speed</div>
            <div class="text-lg font-black text-slate-800" id="statAvg">--</div>
         </div>
         <div class="bg-emerald-50 border border-emerald-100 px-4 py-2 rounded-lg text-center">
            <div class="text-[10px] uppercase font-bold text-emerald-400 tracking-wider">Fastest</div>
            <div class="text-lg font-black text-emerald-600" id="statFast">--</div>
         </div>
      </div>

    </div>
  </header>

  <main class="flex-grow max-w-6xl mx-auto w-full px-6 py-8">
    
    <div class="relative max-w-lg mx-auto mb-10 group">
      <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
        <i class="fa-solid fa-search text-slate-400 group-focus-within:text-blue-500 transition"></i>
      </div>
      <input type="text" id="searchInput" onkeyup="renderData()" 
             class="block w-full pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-semibold shadow-sm focus:ring-4 focus:ring-blue-50 focus:border-blue-500 outline-none transition" 
             placeholder="Search by Job ID, Inspector, or Unit...">
    </div>

    <div id="cardsArea" class="space-y-4">
       <div class="flex flex-col items-center justify-center py-20 opacity-50">
          <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i>
          <span class="text-sm font-bold">Analyzing Performance Data...</span>
       </div>
    </div>

  </main>

  <script>
    let RAW_DATA = [];

    // 1. INITIALIZE
    document.addEventListener('DOMContentLoaded', () => {
       fetchData();
    });

    // 2. FETCH DATA FROM GOOGLE APPS SCRIPT
    function fetchData() {
       // We call 'getAllJobs' from Code.gs
       google.script.run
         .withSuccessHandler(data => {
            processData(data);
         })
         .withFailureHandler(err => {
            document.getElementById('cardsArea').innerHTML = `
              <div class="bg-red-50 text-red-600 p-4 rounded-xl text-center font-bold">
                Error: ${err.message} <br>
                <small>Make sure you redeployed the script!</small>
              </div>`;
         })
         .getAllJobs();
    }

    // 3. PROCESS DATA (Logic Engine)
    function processData(data) {
       RAW_DATA = data.map(row => {
          // A. Parse SUBMISSION Date (Col 1/Timestamp)
          const ts = row["Timestamp"] || row[0];
          const subDate = ts ? new Date(ts) : null;

          // B. Parse INSPECTION Date (From JSON)
          let inspDate = null;
          let jsonStr = row["Inspector Structured Data"] || row["json"];
          
          if (jsonStr && typeof jsonStr === 'string' && jsonStr.trim().startsWith('{')) {
             try {
                const obj = JSON.parse(jsonStr);
                // Find any key that looks like "Tarikh" or "Date"
                const dateKey = Object.keys(obj).find(k => k.toLowerCase().includes('tarikh') || k.toLowerCase().includes('date'));
                if (dateKey && obj[dateKey]) {
                   inspDate = new Date(obj[dateKey]);
                }
             } catch(e) {}
          }

          // C. Calculate DIFF
          let days = null;
          if (subDate && inspDate) {
             const ms = Math.abs(inspDate - subDate);
             days = Math.ceil(ms / (1000 * 60 * 60 * 24));
          }

          // D. Fallback status
          const inspector = row["Assigned Inspector 1"] || "Unassigned";
          const unit = row["Nama pasukan / unit"] || row["Unit"] || "Unknown Unit";
          const id = row["Job ID"] || row["ID"];

          return { id, unit, inspector, subDate, inspDate, days };
       });

       updateStats();
       renderData();
    }

    // 4. RENDER CARDS (The Visual Part)
    function renderData() {
       const term = document.getElementById('searchInput').value.toLowerCase();
       const container = document.getElementById('cardsArea');
       
       // Filter
       const filtered = RAW_DATA.filter(j => 
          (j.id && j.id.toLowerCase().includes(term)) || 
          (j.unit && j.unit.toLowerCase().includes(term)) || 
          (j.inspector && j.inspector.toLowerCase().includes(term))
       );

       if (filtered.length === 0) {
          container.innerHTML = `<div class="text-center py-10 text-slate-400">No jobs match your search.</div>`;
          return;
       }

       // HTML Generation
       container.innerHTML = filtered.map((job, index) => {
          
          // Logic: Determine Status & Style
          let statusClass = "status-pending";
          let daysLabel = "Waiting";
          let inspDateText = "Pending Inspection";
          let icon = "fa-clock";
          let color = "text-slate-400";

          if (job.days !== null) {
             daysLabel = `${job.days} DAYS`;
             inspDateText = job.inspDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
             
             if (job.days <= 3) {
                statusClass = "status-fast";
                icon = "fa-bolt";
                color = "text-emerald-500";
             } else if (job.days <= 7) {
                statusClass = "status-avg";
                icon = "fa-check";
                color = "text-amber-500";
             } else {
                statusClass = "status-slow";
                icon = "fa-triangle-exclamation";
                color = "text-red-500";
             }
          }

          const subDateText = job.subDate ? job.subDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : "N/A";
          const delay = index * 50; // Stagger animation

          return `
          <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-200 flex flex-col md:flex-row items-center gap-6 card-anim ${statusClass}" style="animation-delay: ${delay}ms">
             
             <div class="w-full md:w-1/4">
                <div class="flex items-center gap-2 mb-1">
                   <div class="h-8 w-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-500">
                      <i class="fa-solid fa-hashtag text-xs"></i>
                   </div>
                   <span class="mono font-bold text-slate-700 text-sm tracking-tighter">${job.id}</span>
                </div>
                <h3 class="font-bold text-slate-800 leading-tight">${job.unit}</h3>
                <p class="text-xs text-slate-400 mt-1 font-medium"><i class="fa-solid fa-user-shield mr-1"></i> ${job.inspector}</p>
             </div>

             <div class="w-full md:flex-1 flex items-center justify-between relative px-2">
                
                <div class="text-center z-10">
                   <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Requested</div>
                   <div class="font-bold text-slate-700 text-sm whitespace-nowrap">${subDateText}</div>
                   <div class="h-3 w-3 rounded-full bg-slate-300 mx-auto mt-2 border-2 border-white shadow"></div>
                </div>

                <div class="timeline-line flex items-center justify-center">
                   <div class="days-badge shadow-sm">
                      <i class="fa-solid ${icon} mr-1 text-[8px]"></i> ${daysLabel}
                   </div>
                </div>

                <div class="text-center z-10">
                   <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Inspected</div>
                   <div class="font-bold ${color} text-sm whitespace-nowrap">${inspDateText}</div>
                   <div class="h-3 w-3 rounded-full ${job.days !== null ? 'bg-current ' + color : 'bg-slate-200'} mx-auto mt-2 border-2 border-white shadow"></div>
                </div>

             </div>

             <div class="hidden md:block">
                <button class="h-10 w-10 rounded-full bg-slate-50 hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition flex items-center justify-center">
                   <i class="fa-solid fa-chevron-right"></i>
                </button>
             </div>

          </div>
          `;
       }).join('');
    }

    // 5. UPDATE HEADER STATS
    function updateStats() {
       const completed = RAW_DATA.filter(j => j.days !== null);
       if(completed.length > 0) {
          const total = completed.reduce((sum, j) => sum + j.days, 0);
          const avg = (total / completed.length).toFixed(1);
          const fast = Math.min(...completed.map(j => j.days));
          
          document.getElementById('statAvg').textContent = avg + "d";
          document.getElementById('statFast').textContent = fast + "d";
       }
    }
  </script>
</body>
</html>
