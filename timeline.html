<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CT&P Portal | Competency Timeline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    
    /* Custom Card Styling */
    .job-card {
      transition: all 0.2s ease;
      border-left: 4px solid transparent;
    }
    .job-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    
    /* Competency Badges */
    .comp-fast { border-left-color: #22c55e; } /* Green */
    .comp-avg  { border-left-color: #eab308; } /* Yellow */
    .comp-slow { border-left-color: #ef4444; } /* Red */
    .comp-none { border-left-color: #94a3b8; } /* Grey */

    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
    .badge-fast { background: #dcfce7; color: #15803d; }
    .badge-avg  { background: #fef9c3; color: #a16207; }
    .badge-slow { background: #fee2e2; color: #b91c1c; }
  </style>
</head>
<body class="text-slate-800">

  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
      <div>
        <div class="text-lg font-extrabold tracking-tight text-slate-900">INSPECTION COMPETENCY</div>
        <div class="text-xs text-slate-500 font-medium">Measuring efficiency from Submission to Execution</div>
      </div>
      <nav class="flex items-center gap-2">
        <a class="px-3 py-2 rounded-lg hover:bg-slate-100 text-sm font-semibold text-slate-600" href="./index.html">Back to Jobs</a>
        <button onclick="loadData()" class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm font-bold shadow-lg hover:bg-slate-800 transition">REFRESH DATA</button>
      </nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-8">
    
    <div class="grid grid-cols-3 gap-4 mb-8">
      <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 text-center">
        <div class="text-xs font-bold text-slate-400 uppercase">Avg. Speed</div>
        <div class="text-2xl font-black text-slate-800 mt-1" id="statAvg">--</div>
        <div class="text-xs text-slate-400">Days / Job</div>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 text-center">
        <div class="text-xs font-bold text-slate-400 uppercase">Fastest</div>
        <div class="text-2xl font-black text-emerald-600 mt-1" id="statFast">--</div>
        <div class="text-xs text-slate-400">Days</div>
      </div>
      <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 text-center">
        <div class="text-xs font-bold text-slate-400 uppercase">Pending</div>
        <div class="text-2xl font-black text-slate-800 mt-1" id="statPending">--</div>
        <div class="text-xs text-slate-400">Jobs</div>
      </div>
    </div>

    <div class="flex items-center gap-2 mb-6">
       <input id="searchInput" onkeyup="renderTimeline()" class="w-full px-4 py-3 rounded-xl border border-slate-200 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Filter by Unit or Inspector Name..." />
    </div>

    <div id="timelineList" class="space-y-4">
      <div class="text-center py-10 text-slate-400 animate-pulse">
        Fetching Inspection Data...
      </div>
    </div>

  </main>

  <script>
    let ALL_JOBS = [];

    // --- 1. FETCH DATA (Connects to your Google Script) ---
    function loadData() {
        const list = document.getElementById('timelineList');
        list.innerHTML = '<div class="text-center py-10 text-slate-400">Loading data from server...</div>';

        // NOTE: We assume your backend has a standard fetch function. 
        // If you usually use 'getAllJobs', use that. 
        // Here we use 'getJobsByInspectorName' with a wildcard or similar if needed, 
        // but typically you have a 'getData' or 'doGet' endpoint.
        
        // For now, let's assume we can fetch EVERYTHING.
        // If this fails, make sure you have a function in Code.gs that returns all rows.
        google.script.run
            .withSuccessHandler(processData)
            .withFailureHandler(err => {
                list.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-xl text-center">Error: ${err.message}</div>`;
            })
            .getAllJobs(); // <--- ENSURE THIS FUNCTION EXISTS IN Code.gs
    }

    // --- 2. PROCESS DATA (The Competency Logic) ---
    function processData(data) {
        ALL_JOBS = data.map(row => {
            // A. Parse Submission Date (Timestamp - Column 0 usually)
            // We try to find the timestamp key or use the first index if array
            let subDateRaw = row["Timestamp"] || row[0]; 
            let subDate = subDateRaw ? new Date(subDateRaw) : null;

            // B. Parse Inspection Date (From JSON Column)
            let inspDate = null;
            let jsonRaw = row["Inspector Structured Data"] || row["json"] || "";
            
            if (jsonRaw && jsonRaw.toString().trim().startsWith("{")) {
                try {
                    const parsed = JSON.parse(jsonRaw);
                    // Look for our "Tarikh Pemeriksaan" field
                    // We look for any key containing "tarikh"
                    const dateKey = Object.keys(parsed).find(k => k.toLowerCase().includes("tarikh"));
                    if (dateKey && parsed[dateKey]) {
                        inspDate = new Date(parsed[dateKey]);
                    }
                } catch(e) { console.log("JSON Error", e); }
            }

            // C. Calculate Competency Gap (Days)
            let daysTaken = null;
            if (subDate && inspDate) {
                const diffTime = Math.abs(inspDate - subDate);
                daysTaken = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            }

            return {
                id: row["Job ID"] || row["ID"] || "N/A",
                unit: row["Nama pasukan / unit"] || row["Unit"] || "Unknown Unit",
                type: row["Jenis pemeriksaan"] || "General",
                inspector: row["Assigned Inspector 1"] || "Unassigned",
                subDate: subDate,
                inspDate: inspDate,
                days: daysTaken,
                raw: row
            };
        });

        // Initial Render
        renderTimeline();
        updateStats();
    }

    // --- 3. RENDER UI ---
    function renderTimeline() {
        const list = document.getElementById('timelineList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        // Filter
        const filtered = ALL_JOBS.filter(j => 
            (j.unit.toLowerCase().includes(search) || j.inspector.toLowerCase().includes(search) || j.id.toLowerCase().includes(search))
        );

        if (filtered.length === 0) {
            list.innerHTML = '<div class="text-center py-10 text-slate-400">No matching jobs found.</div>';
            return;
        }

        // Generate HTML
        list.innerHTML = filtered.map(job => {
            
            // Determine Competency Visuals
            let compClass = "comp-none";
            let badgeHtml = `<span class="badge bg-slate-100 text-slate-500">PENDING INSPECTION</span>`;
            let daysText = "Not finished yet";

            if (job.days !== null) {
                if (job.days <= 3) {
                    compClass = "comp-fast";
                    badgeHtml = `<span class="badge badge-fast">‚ö° EXCELLENT (${job.days} DAYS)</span>`;
                } else if (job.days <= 7) {
                    compClass = "comp-avg";
                    badgeHtml = `<span class="badge badge-avg">‚ö†Ô∏è AVERAGE (${job.days} DAYS)</span>`;
                } else {
                    compClass = "comp-slow";
                    badgeHtml = `<span class="badge badge-slow">üî• SLOW (${job.days} DAYS)</span>`;
                }
                daysText = `${job.days} Days to complete`;
            }

            // Format Dates nicely
            const d1 = job.subDate ? job.subDate.toLocaleDateString('en-GB') : "-";
            const d2 = job.inspDate ? job.inspDate.toLocaleDateString('en-GB') : "Waiting...";

            return `
            <div class="job-card bg-white p-5 rounded-2xl shadow-sm border border-slate-100 ${compClass}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-black text-slate-700 mono text-sm bg-slate-100 px-2 py-1 rounded">${job.id}</span>
                            ${badgeHtml}
                        </div>
                        <h3 class="font-bold text-lg text-slate-800">${job.unit}</h3>
                        <div class="text-xs font-semibold text-slate-400 uppercase tracking-wide">${job.type}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-slate-400">INSPECTOR</div>
                        <div class="text-sm font-bold text-slate-700">${job.inspector}</div>
                    </div>
                </div>

                <div class="relative pt-4 pb-2">
                    <div class="flex items-center justify-between text-xs font-semibold text-slate-500 mb-2">
                        <div>
                            <div class="text-[10px] uppercase text-slate-400">Submission</div>
                            <div>${d1}</div>
                        </div>
                        
                        <div class="h-0.5 flex-1 mx-4 bg-slate-100 relative top-1">
                             <div class="absolute -top-2 left-1/2 -translate-x-1/2 bg-white px-2 text-[10px] text-slate-400 font-bold whitespace-nowrap">
                                ${daysText}
                             </div>
                        </div>

                        <div class="text-right">
                            <div class="text-[10px] uppercase text-slate-400">Inspection Date</div>
                            <div class="${job.inspDate ? 'text-slate-700' : 'text-orange-400'}">${d2}</div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // --- 4. UPDATE STATS DASHBOARD ---
    function updateStats() {
        const completed = ALL_JOBS.filter(j => j.days !== null);
        
        if (completed.length > 0) {
            const totalDays = completed.reduce((sum, j) => sum + j.days, 0);
            const avg = (totalDays / completed.length).toFixed(1);
            const fastest = Math.min(...completed.map(j => j.days));
            
            document.getElementById('statAvg').textContent = avg;
            document.getElementById('statFast').textContent = fastest;
        }
        
        document.getElementById('statPending').textContent = ALL_JOBS.filter(j => j.days === null).length;
    }

    // Load on start
    document.addEventListener('DOMContentLoaded', loadData);

  </script>
</body>
</html>
