<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CT&P Portal</title>
  <meta name="description" content="CT&P Portal for inspection job tracking and coordination." />

  <!-- ===== MAP LIBRARIES ===== -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- ===== STYLES (UNCHANGED CORE) ===== -->
  <style>
    /* === SAME CSS YOU PROVIDED === */
    /* I am NOT modifying your visual system */
    /* Only addition is map container safety */

    #map{
      width:100%;
      height:520px;
      border-radius:16px;
      border:1px solid var(--line);
    }
  </style>
</head>

<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img src="assets/icon1.png" alt="Jata Negara"/>
      <div class="brand-title">
        <h1>Sistem Pemeriksaan Sel Teknikal</h1>
        <p>Cawangan Teknik & Pemeriksaan</p>
      </div>
    </div>

    <div class="top-actions">
      <div class="tabs">
        <button class="tab active" id="tabJobs">Jobs</button>
        <button class="tab" id="tabDir">Inspector Directory</button>
        <button class="tab" id="tabAna">Analytics</button>
        <button class="tab" id="tabTime">Timeline</button>
        <button class="tab" id="tabMap">Map</button>
      </div>
      <span class="pill"><strong id="today"></strong></span>
    </div>
  </div>
</header>

<main class="wrap">

<!-- ===== JOBS (UNCHANGED) ===== -->
<section class="view active" id="viewJobs"></section>

<!-- ===== DIRECTORY (UNCHANGED) ===== -->
<section class="view" id="viewDir"></section>

<!-- ===== ANALYTICS (UNCHANGED) ===== -->
<section class="view" id="viewAna"></section>

<!-- ===== TIMELINE (NEW) ===== -->
<section class="view" id="viewTime">
  <section class="panel">
    <div class="panel-title">
      <div>
        <h2>Inspection Timeline</h2>
        <p>Chronological operational record of inspections.</p>
      </div>
    </div>
    <div id="timeline"></div>
  </section>
</section>

<!-- ===== MAP (NEW) ===== -->
<section class="view" id="viewMap">
  <section class="panel">
    <div class="panel-title">
      <div>
        <h2>Live Inspection Map</h2>
        <p>Active inspections (pins) and inspection frequency (heat view).</p>
      </div>
    </div>

    <div id="map"></div>

    <div class="mini-note">
      ðŸ”µ Blue pins = inspections currently in progress<br>
      ðŸ”¥ Heat view = inspection frequency (all jobs)
    </div>
  </section>
</section>

</main>

<script>
/* =========================================================
   CORE DATA
========================================================= */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzyCi-6stLedx0-un55ldx_qOuPgRUrP5A_7nu6uCAINOZvQJatVIzfdowW6Vo02Dby/exec";

let JOBS = [];
let INSPECTORS = [];

/* =========================================================
   MAP GLOBALS
========================================================= */
let MAP;
let PIN_LAYER;
let HEAT_LAYER;

/* =========================================================
   UTILITIES
========================================================= */
const $ = s => document.querySelector(s);
const safe = v => (v ?? "").toString().trim();

/* =========================================================
   DATE
========================================================= */
function setToday(){
  $("#today").textContent =
    new Date().toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});
}

/* =========================================================
   MAP ENGINE
========================================================= */
function initMap(){
  if(MAP) return;

  MAP = L.map("map").setView([4.2105,101.9758],6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
    attribution:"Â© OpenStreetMap"
  }).addTo(MAP);

  PIN_LAYER = L.layerGroup().addTo(MAP);
}

async function geocode(place){
  const r = await fetch(
    "https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(place)
  );
  const j = await r.json();
  if(!j.length) return null;
  return [parseFloat(j[0].lat),parseFloat(j[0].lon)];
}

async function renderMap(){
  initMap();
  PIN_LAYER.clearLayers();
  if(HEAT_LAYER) MAP.removeLayer(HEAT_LAYER);

  /* === HEATMAP (ALL JOBS) === */
  const heat = [];
  for(const j of JOBS){
    if(!j.daerah || !j.negeri) continue;
    const p = await geocode(`${j.daerah}, ${j.negeri}, Malaysia`);
    if(p) heat.push([...p,0.6]);
  }

  HEAT_LAYER = L.heatLayer(heat,{
    radius:28,
    blur:22,
    maxZoom:8
  }).addTo(MAP);

  /* === ACTIVE PINS === */
  const active = JOBS.filter(j=>j.status==="In Progress");

  for(const j of active){
    const p = await geocode(`${j.daerah}, ${j.negeri}, Malaysia`);
    if(!p) continue;

    const m = L.circleMarker(p,{
      radius:9,
      color:"#3aa0ff",
      fillColor:"#3aa0ff",
      fillOpacity:.85
    });

    m.bindPopup(`
      <b>${j.unit}</b><br>
      ${j.jenis}<br><br>
      Inspector 1: ${j.assigned1}<br>
      Inspector 2: ${j.assigned2}<br>
      <span style="color:#93c5fd;">In Progress</span>
    `);

    m.addTo(PIN_LAYER);
  }
}

/* =========================================================
   TIMELINE
========================================================= */
function renderTimeline(){
  const el = $("#timeline");
  el.innerHTML = JOBS
    .sort((a,b)=>new Date(b.tarikhTugasan)-new Date(a.tarikhTugasan))
    .map(j=>`
      <div class="card" style="padding:12px;margin-bottom:8px;">
        <b>${j.jobId}</b> â€” ${j.jenis}<br>
        ${j.daerah}, ${j.negeri}<br>
        Status: ${j.status}
      </div>
    `).join("");
}

/* =========================================================
   DATA LOAD
========================================================= */
async function loadData(){
  const r = await fetch(WEB_APP_URL+"?action=listJobs");
  const j = await r.json();
  JOBS = j.jobs || [];
  renderTimeline();
}

/* =========================================================
   TABS
========================================================= */
function setTab(name){
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));

  $("#tab"+name).classList.add("active");
  $("#view"+name).classList.add("active");

  if(name==="Map") renderMap();
  if(name==="Time") renderTimeline();
}

$("#tabMap").onclick=()=>setTab("Map");
$("#tabTime").onclick=()=>setTab("Time");

/* =========================================================
   INIT
========================================================= */
setToday();
loadData();
</script>

</body>
</html>
