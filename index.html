<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CT&P Portal</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0c121a;
      --text:#e7eef8; --muted:#9fb0c6; --line:rgba(255,255,255,.08);
      --accent:#3aa0ff; --good:#23c26b; --warn:#ffb020; --bad:#ff4d4d;
      --shadow:0 20px 60px rgba(0,0,0,.45); --radius:16px;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); overflow:hidden; }
    
    .app{ display:grid; grid-template-columns: 320px 1fr; height:100vh; }
    
    /* Sidebar */
    .sidebar{ background:var(--panel); border-right:1px solid var(--line); display:flex; flex-direction:column; }
    .nav-header{ padding:24px; border-bottom:1px solid var(--line); }
    .brand{ font-weight:800; font-size:20px; letter-spacing:-0.5px; color:var(--accent); }
    
    .scroll-area{ flex:1; overflow-y:auto; padding:12px; }
    .list-item{ 
      padding:16px; border-radius:12px; margin-bottom:8px; cursor:pointer; 
      transition:all 0.2s; border:1px solid transparent; background:rgba(255,255,255,0.02);
    }
    .list-item:hover{ background:var(--panel2); border-color:var(--line); }
    
    /* Main Map Area */
    .main{ position:relative; background:#000; }
    #map{ width:100%; height:100%; }

    /* Right Drawer */
    .drawer-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.5); opacity:0; pointer-events:none; transition:0.3s; z-index:100; }
    .drawer-overlay.open{ opacity:1; pointer-events:auto; }
    .drawer{ 
      position:fixed; top:0; right:-400px; width:400px; height:100%; 
      background:var(--panel); border-left:1px solid var(--line); z-index:101;
      transition:0.4s cubic-bezier(0.4, 0, 0.2, 1); padding:32px; overflow-y:auto;
    }
    .drawer.open{ right:0; box-shadow: var(--shadow); }

    /* UI Components */
    .kv{ margin-bottom:20px; }
    .kv .label{ color:var(--muted); font-size:10px; text-transform:uppercase; font-weight:700; margin-bottom:4px; letter-spacing:0.5px; }
    .kv .val{ font-weight:500; font-size:14px; }
    
    .badge{ padding:4px 8px; border-radius:6px; font-size:10px; font-weight:800; border:1px solid transparent; }
    
    .search-box{ padding:16px; }
    input{ width:100%; background:var(--panel2); border:1px solid var(--line); color:#white; padding:12px; border-radius:10px; outline:none; }
  </style>
</head>
<body>

  <div class="app">
    <aside class="sidebar">
      <div class="nav-header">
        <div class="brand">CT&P PORTAL</div>
        <div style="font-size:10px; color:var(--muted); margin-top:4px;">PENGURUSAN PEMERIKSAAN</div>
      </div>
      
      <div class="search-box">
        <input type="text" id="q" placeholder="Cari Job ID atau Unit...">
      </div>

      <div class="scroll-area" id="list">
        </div>
    </aside>

    <main class="main">
      <div id="map"></div>
      
      <div style="position:absolute; top:20px; right:20px; z-index:1000; display:flex; gap:10px;">
        <a href="./timeline.html" style="background:var(--panel); color:white; padding:10px 20px; border-radius:10px; text-decoration:none; font-size:12px; font-weight:700; border:1px solid var(--line);">TIMELINE</a>
        <button id="refresh" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:10px; font-weight:700; cursor:pointer;">REFRESH</button>
      </div>
    </main>
  </div>

  <div class="drawer-overlay" id="overlay"></div>
  <div class="drawer" id="drawer">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:30px;">
      <div>
        <h2 id="dTitle" style="margin:0; font-size:24px; font-weight:900;">-</h2>
        <p id="dSub" style="color:var(--muted); margin:4px 0 0 0; font-size:12px;">-</p>
      </div>
      <button onclick="closeDrawer()" style="background:none; border:none; color:var(--muted); font-size:20px; cursor:pointer;">&times;</button>
    </div>

    <div id="kvJob">
      </div>

    <div style="margin-top:30px; padding-top:20px; border-top:1px solid var(--line);">
       <div class="label" style="color:var(--muted); font-size:10px; font-weight:700; margin-bottom:12px;">PEMERIKSA BERTUGAS</div>
       <div id="dInspectors" style="display:flex; gap:10px;"></div>
    </div>
  </div>

  <script src="./js/config.js"></script>
  <script src="./js/api.js"></script>
  <script src="./js/ui.js"></script>
  
  <script>
    let JOBS = [];
    let MAP, PIN_LAYER, HEAT_LAYER;

    const $list = document.querySelector("#list");
    const $drawer = document.querySelector("#drawer");
    const $overlay = document.querySelector("#overlay");
    const $kvJob = document.querySelector("#kvJob");
    const $dTitle = document.querySelector("#dTitle");
    const $dSub = document.querySelector("#dSub");
    const $dInspectors = document.querySelector("#dInspectors");

    // Initialize Page
    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      loadData();
    });

    function initMap() {
      MAP = L.map("map", { zoomControl: false }).setView([4.2105, 101.9758], 6);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(MAP);
      PIN_LAYER = L.layerGroup().addTo(MAP);
    }

    async function loadData() {
      $list.innerHTML = '<div style="padding:20px; color:var(--muted); font-size:12px;">Memuatkan data...</div>';
      try {
        const res = await API.listJobs();
        JOBS = res.jobs || [];
        renderJobs();
        updateMap();
      } catch (e) {
        $list.innerHTML = '<div style="padding:20px; color:var(--bad);">Gagal memuatkan data.</div>';
      }
    }

    function renderJobs() {
      const q = document.querySelector("#q").value.toLowerCase();
      const filtered = JOBS.filter(j => 
        j["Job ID"].toLowerCase().includes(q) || 
        j["Nama Pasukan / Unit"].toLowerCase().includes(q)
      );

      $list.innerHTML = filtered.map(j => `
        <div class="list-item" onclick='openDrawer(${JSON.stringify(j).replace(/'/g, "&apos;")})'>
          <div style="font-size:10px; font-weight:800; color:var(--accent); margin-bottom:4px;">${j["Job ID"]}</div>
          <div style="font-weight:700; font-size:14px; margin-bottom:2px;">${j["Nama Pasukan / Unit"]}</div>
          <div style="font-size:11px; color:var(--muted);">${j["Negeri"]}</div>
        </div>
      `).join("");
    }

    function openDrawer(job) {
      $dTitle.textContent = job["Job ID"];
      $dSub.textContent = `${job["Nama Pasukan / Unit"]} | ${job["Jenis Pemeriksaan"]}`;

      // Logic: Tarikh Tugasan range
      const tugasanRange = `${fmtDate(job["Assigned Date"])} hingga ${fmtDate(job["End Date"])}`;
      
      // Logic: Competency Badge (From ui.js)
      const compHtml = typeof getKompetensiBadge === 'function' 
        ? getKompetensiBadge(job["Timestamp"], job["Inspector Structured Data"]) 
        : "-";

      $kvJob.innerHTML = [
        kvRow("Job ID", job["Job ID"]),
        kvRow("Tarikh Permohonan", fmtDate(job["Timestamp"])),
        kvRow("Tarikh Tugasan", tugasanRange),
        kvRow("Kompetensi", compHtml),
        kvRow("Unit / Pasukan", job["Nama Pasukan / Unit"]),
        kvRow("Jenis Pemeriksaan", job["Jenis Pemeriksaan"]),
        kvRow("Status", job["Status"])
      ].join("");

      // Photo handling
      $dInspectors.innerHTML = ""; // Clear existing
      // Logic would go here to find photos in database...

      $drawer.classList.add("open");
      $overlay.classList.add("open");
    }

    function closeDrawer() {
      $drawer.classList.remove("open");
      $overlay.classList.remove("open");
    }

    function kvRow(label, val) {
      return `
        <div class="kv">
          <div class="label">${label}</div>
          <div class="val">${val || "-"}</div>
        </div>
      `;
    }

    function fmtDate(v) {
      if (!v) return "-";
      const d = new Date(v);
      return isNaN(d.getTime()) ? v : d.toLocaleDateString("en-GB");
    }

    async function updateMap() {
       PIN_LAYER.clearLayers();
       JOBS.forEach(j => {
          const lat = parseFloat(j.Lat);
          const lng = parseFloat(j.Lng);
          if (isFinite(lat) && isFinite(lng)) {
             L.circleMarker([lat, lng], { radius: 6, color: '#3aa0ff' }).addTo(PIN_LAYER)
              .bindPopup(`<b>${j["Job ID"]}</b><br>${j["Nama Pasukan / Unit"]}`);
          }
       });
    }

    // Search trigger
    document.querySelector("#q").addEventListener("input", renderJobs);
    document.querySelector("#refresh").addEventListener("click", loadData);
    $overlay.addEventListener("click", closeDrawer);
  </script>
</body>
</html>
